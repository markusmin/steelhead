---
title: "Columbia Basin Research"
subtitle: "Progress Report: A Bayesian multidirectional, multistate model to resolve the migration pathways of adult Steelhead within the Columbia River Basin"
author: "Markus Min"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document:
    reference_docx: CBR_template.docx
  pdf_document: default
documentclass: report
toc: TRUE
toc-depth: 2
geometry: margin=1in
linestretch: 1.1
fontsize: 12pt
header-includes:
  - \usepackage{lineno}
  - \linenumbers
urlcolor: blue
bibliography: Steelhead.bib
csl: jpe.csl
always_allow_html: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">"
)
```

```{r load_functions_libraries, echo = FALSE, warning = FALSE, message = FALSE}
library(here)
library(kableExtra)
library(tidyverse)
library(flextable)
library(officer)

# Make a function to actually fit the flextable
FitFlextableToPage <- function(ft, pgwidth = 8){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

# Get the tributary order for plotting, to keep it consistent throughout the tables
natal_origin_order <- c("Hood_River", "Fifteenmile_Creek", "Deschutes_River",  "John_Day_River",  "Umatilla_River", "Walla_Walla_River",
                        "Yakima_River", "Wenatchee_River", "Entiat_River", "Methow_River", "Okanogan_River",                
                        "Tucannon_River", "Clearwater_River", "Asotin_Creek", "Grande_Ronde_River", "Salmon_River", "Imnaha_River")

middle_columbia_origins <- c("Fifteenmile Creek", "Deschutes River", "John Day River", "Umatilla River", "Walla Walla River", "Yakima River")
upper_columbia_origins <- c("Wenatchee River", "Entiat River",    "Okanogan River",  "Methow River")
snake_origins <- c("Tucannon River",   "Asotin Creek", "Clearwater River", "Salmon River",  "Grande Ronde River", "Imnaha River")

# ORDER THE STATES
model_states = c(
  # Mainstem states (9)
  "mainstem, mouth to BON",
  "mainstem, BON to MCN",
  "mainstem, MCN to ICH or PRA",
  "mainstem, PRA to RIS",
  "mainstem, RIS to RRE",
  "mainstem, RRE to WEL",
  "mainstem, upstream of WEL",
  "mainstem, ICH to LGR",
  "mainstem, upstream of LGR",
  
  # Tributary states ()
  # With detection efficiencies in the model, we now have more tributary states,
  # since we have an upstream and a river mouth state
  
  # "Deschutes River", 
  "Deschutes River Mouth", "Deschutes River Upstream",
  # "John Day River", 
  "John Day River Mouth", "John Day River Upstream",
  # "Hood River",
  "Hood River Mouth", "Hood River Upstream",
  # "Fifteenmile Creek", 
  "Fifteenmile Creek Mouth", "Fifteenmile Creek Upstream",
  # "Umatilla River",
  "Umatilla River Mouth", "Umatilla River Upstream",
  # "Yakima River",
  "Yakima River Mouth", "Yakima River Upstream",
  # "Walla Walla River",
  "Walla Walla River Mouth", "Walla Walla River Upstream",
  # "Wenatchee River", 
  "Wenatchee River Mouth", "Wenatchee River Upstream",
  # "Entiat River", 
  "Entiat River Mouth", "Entiat River Upstream",
  # "Okanogan River", 
  "Okanogan River Mouth", "Okanogan River Upstream",
  # "Methow River", 
  "Methow River Mouth", "Methow River Upstream",
  # "Tucannon River",
  "Tucannon River Mouth", "Tucannon River Upstream",
  # "Asotin Creek", 
  "Asotin Creek Mouth", "Asotin Creek Upstream",
  "Clearwater River",
  "Salmon River",
  "Grande Ronde River",
  # "Imnaha River",
  "Imnaha River Mouth", "Imnaha River Upstream",
  "BON to MCN other tributaries",
  "Upstream WEL other tributaries",
  
  # Loss
  "loss"
)

upstream_indices <- grep("Creek Upstream|River Upstream", model_states)
states_order_for_plot <- gsub(" Mouth", "", model_states[-upstream_indices])
# Make a couple of changes to make them be in the order from most downstream to most upstream
states_order_for_plot[10] <- "Hood River"
states_order_for_plot[11] <- "Fifteenmile Creek"
states_order_for_plot[12] <- "Deschutes River"
states_order_for_plot[13] <- "John Day River"
states_order_for_plot[15] <- "Walla Walla River"
states_order_for_plot[16] <- "Yakima River"
states_order_for_plot[19] <- "Methow River"
states_order_for_plot[20] <- "Okanogan River"

states_order_for_plot[16:29] <- states_order_for_plot[15:28]
states_order_for_plot[15] <- "BON to MCN other tributaries"
states_order_for_plot[23:29] <- states_order_for_plot[22:28]
states_order_for_plot[22] <- "Upstream WEL other tributaries"
states_order_for_plot[29] <- "loss"

states_order_for_plot[24] <- "Clearwater River"
states_order_for_plot[25] <- "Asotin Creek"
states_order_for_plot[26] <- "Grande Ronde River"
states_order_for_plot[27] <- "Salmon River"

# create a function to generate flextable
prob_flextable <- function(prob_table, trib_name){
  # first, drop all of the upstream states (these are not informative) and rename mouth states by dropping mouth from state name
  prob_table %>% 
    subset(., !(grepl("Creek Upstream|River Upstream", from))) %>% 
    mutate(from = gsub(" Mouth", "", from)) %>% 
    mutate(to = gsub(" Mouth", "", to)) -> prob_table
    
  
  
  # second, reorder the table by the states
  prob_table <- prob_table[order(factor(prob_table$from, levels=states_order_for_plot)),]
  
  
  flextable(prob_table) %>% 
    align(part = "all") %>% # left align
    set_caption(caption = paste0("Movement probabilities for ", trib_name, " Steelhead. Asterisks indicate movement probabilities that are shared across all natal origins within this DPS.")) %>% 
    font(fontname = "Times New Roman (Body)", part = "all") %>% 
    fontsize(size = 10, part = "body") %>% 
    theme_booktabs() %>% # default theme
    FitFlextableToPage() -> table
  
  return(table)
}
```


# Executive summary

Columbia River Steelhead, who spend more time as adults in freshwater than any other salmonid in the basin, have notoriously complex adult migration pathways, characterized frequently by indirect pathways home, overshooting natal tributaries, and falling back over and through hydroelectric dams. Previous studies have characterized specific movements of interest (i.e., overshoot and fallback) and examined the effect of some factors on these movements, but have not presented a comprehensive view of the adult Steelhead migration.

<br>

Here, we present a progress update on a new modeling framework that is capable of modeling the entire adult migration of Steelhead, including upstream movements, downstream movements, and movements into tributaries. This modeling framework translates the Columbia River Basin into a series of interconnected states, each representing a reach of the mainstem Columbia or Snake River between hydroelectric dams or a tributary that flows into them. We converted detections of over 60,000 Steelhead over 17 years from each of the hundreds of PIT tag detection sites in the Columbia River Basin into a sequence of state visits for each fish, and fit a Bayesian multistate model to these data using the Stan programming language. This model also uses the network of PIT tag antennas in each tributary to correct for detection efficiency in each of these tributaries. From this model, we generate movement probabilities for fish from each of 17 different natal origins (tributaries), including probabilities of homing, fallback, and overshoot.

<br>

With the current model configuration, we were able to generate estimates of the probability of key movements for different populations. For example, we were able to determine which populations had a high probability of overshooting (e.g., John Day River, Umatilla River, Entiat River, Wenatchee River, and Walla Walla River Steelhead) and that for Wenatchee River Steelhead, overshoot was particularly detrimental: Wenatchee River Steelhead that did not overshoot had a four times higher probability of making it home than did those that did. 

<br>

Work on this model is ongoing. The model's primary strength is that it is highly flexible: it can simultaneously account for and parse the effect of many different covariates, including flow, spill, temperature, hatchery rearing practices, and juvenile barging. In future configurations of the model, these covariates will be included to address questions such as how winter spill affects fallback, how temperature affects overshooting, and how hatchery rearing practices such as juvenile acclimation affect decisions that these fish make as adults.



# Introduction

Steelhead (anadromous *Oncorhynchus mykiss*) in the Columbia River Basin, including all those found above Bonneville Dam, are listed under the Endangered Species Act. The five Columbia River Basin distinct population segments (DPSs) were first listed in the late 1990s, and are all currently listed as threatened. Despite their protected status and continued recovery efforts, counts of returning Steelhead to Bonneville Dam have been lower in the last five years than they were at the time of listing, and recently completed 5-year reviews for Columbia River Steelhead reaffirmed their status as threatened [@NMFS2022; @NMFS2022a; @NMFS2022b; @NMFS2022c].

<br>

One element of the life history of Columbia River Basin Steelhead that may make them more vulnerable to anthropogenic modifications of the Columbia River is their adult migration. Relative to other salmonids, Steelhead from the Columbia River Basin spend longer in freshwater as adults. Essentially all populations of Steelhead in the Columbia River Basin are stream-maturing [@Busby1996], meaning that these fish enter freshwater in a sexually immature state and then spend up to a year in freshwater prior to spawning. Also known as summer Steelhead, these fish enter freshwater between May and October and spawn the following spring, typically between March and May [@Busby1996]. Between their entry into freshwater and arrival at spawning grounds, Columbia River Steelhead exhibit considerable variability in their migration patterns. Virtually all interior Columbia River Steelhead overwinter in freshwater; the majority of individuals are known to overwinter in tributaries, but up to 20% of individuals in a given year have been observed to overwinter in the hydrosystem, which comprises the mainstem habitat between the hydroelectric dams in the federal Columbia River power system [@Keefer2008]. Additionally, as individuals migrate upstream toward natal tributaries, the majority of individuals have been observed to temporarily stage in nonnatal tributaries downstream of their natal tributary [@High2006]. This behavior increases with increasing mainstem river temperature, indicating the use of these colder waters as coldwater refugia [@High2006]. These highly variable movement patterns and increased duration in freshwater make Steelhead more vulnerable to the hazards faced in freshwater.

<br>

Descending dams, also known as fallback [@Boggs2004], is another common behavior observed in adult Steelhead, with about 20% of Steelhead observed to fall back over at at least one mainstem dam [@Boggs2004]. This behavior can occur as individuals are migrating upstream to natal tributaries, which we refer to as "en-route fallback", but can also occur once individuals have ascended mainstem dams upstream of natal tributaries (a behavior known as overshoot). We refer to fallback that has occurred after Steelhead have overshot natal tributaries as "post-overshoot fallback", and in this case fallback is necessary for individuals to return to natal tributaries. Overshoot and fallback can affect the ability of individuals to successfully home to spawning grounds, and therefore are consequential for the persistence of ESA-listed populations. Individuals that fall back during their upstream migration (prior to reaching or overshooting their natal tributary) are less likely to return to their natal tributaries or hatcheries [@Bjornn2000; @Keefer2005]. Furthermore, migration success to natal tributaries decreases with increased overshooting [@Richins2018], and many overshooting fish are observed to stray to tributaries upstream of the overshoot dam.

<br>

The decreased migration success associated with overshoot and fallback may be due to the hazardous nature of downstream passage for adults, which is often limited to the powerhouse during the primary months that Steelhead are overwintering [@Khan2013]. The incidence of mortality for adult Steelhead passing downstream at dams is highly variable, but recent estimates of 48-hour survival at McNary Dam indicate around 90% survival for individuals passing through turbines and 97% survival for individuals passing through the spillway [@Associates2014]. Mortality in downstream passage routes is implicated by low survival of Steelhead kelts, which decrease with increasing number of dams that must be navigated as they move downstream to the ocean, with mortality of 84-96% for kelts released at Lower Granite Dam, 38-40% at McNary Dam, and 20-37% at John Day Dam [@Wertheimer2005].

<br>

Because of the association between overshoot and fallback and decreased migration success, previous studies have investigated the influence of various factors on the incidence of these behaviors. Rates of overshoot have been observed to vary considerably among populations, with some studies finding a positive relationship with increasing mainstem water temperature and hatchery rearing upstream of the natal tributary [@Richins2018]. In spring-summer Chinook, @Boggs2004 observed a positive relationship between fallback rates and river discharge. However, these previous studies have looked at these various factors only in isolation and for specific movements, which complicates the modeling of emergent properties and interactions between behaviors, environmental conditions, and populations, and can be challenging in the face of sparse data in some settings. In this progress report, we present a multistate model that is capable of modeling the entire adult Steelhead migration, from first detection at Bonneville Dam to arrival in natal tributaries. This model, which does not constrain movement to only be upstream, allows the complex, multidirectional movement of adult Steelhead to be modeled in full and allows many movements of interest, including fallback, overshoot, and homing, to be estimated in a single framework. The data used in this model were passive integrated transponder (PIT) tag detection histories. This modeling framework is capable of accommodating the effect of multiple categorical and continuous covariates on movement probabilities at each step within the migration. By examining how Steelhead movement probabilities, particularly those of conservation concern, such as overshoot, fallback, homing, and straying, vary by population and are influenced by various factors, this modeling framework will improve our understanding of how both environmental and anthropogenically influenced conditions affect how Steelhead move within the Columbia River and its tributaries.



# Methods

## Study area
![Figure 1. The study area, showing all mainstem dams that currently have PIT arrays. Dams that are used to delineate states in the model are in black, whereas those that are not are in grey. Tributaries where fish in our dataset originated are labeled. BON = Bonneville Dam; TDA = The Dalles Dam; JDA = John Day Dam; MCN = McNary Dam; PRA = Priest Rapids Dam; RIS = Rock Island Dam; RRE = Rocky Reach Dam; WEL = Wells Dam; ICH = Ice Harbor Dam; LMO = Lower Monumental Dam; LGO = Little Goose Dam; LGR = Lower Granite Dam.](.//figures/CRB_map_pres_dams.pdf){width=100%}

## Modeling overview
![Figure 2. The model schematic.](.//figures/full_model_diagram.jpg){width=100%}

In our model, the Columbia River and its tributaries are modeled as a series of connected states, with states defined as either reaches of the mainstem Columbia or Snake River between dams with PIT tag detection capabilities in the adult ladders or tributaries with PIT tag detectors. Fig. 2 shows all of the states in our model; movements over some dams (e.g., The Dalles Dam, John Day Dam, Lower Monumental Dam, or Lower Goose Dam) were not explicitly modeled due to these dams not having PIT tag detection capabilities for the duration of our study period. Future iterations of the model could be configured to include these dams for part of the time series by creating more model states. For example, to use the Dalles and John Day Dams to delineate additional states, state 2 in Fig. 2 (mainstem, Bonneville Dam to McNary Dam) would be split into three states: (1) mainstem, Bonneville Dam to The Dalles Dam; (2) mainstem, The Dalles Dam to John Day Dam; and (3) mainstem, John Day Dam to McNary Dam. This would allow the estimation of fallback and overshoot at The Dalles Dam and John Day Dam (which would be of particular interest to populations near these dams, such as the Deschutes River or Fifteenmile Creek), but would require a temporally-varying state configuration. 

<br>

An additional state in our model not shown in the schematic, but which can be reached from any state, is the absorbing "loss" state, which a fish enters once the detection history ends. Once a fish has entered the loss state, it can no longer leave it. Movements into the loss state are either mortality (via natural mortality, harvest, mortality due to the hydrosystem, etc.), the start of kelt movement following spawning (as all kelt movements were removed to isolated the adult migration prior to spawning), or unobserved movements out of the state, which could be due to missed detections at PIT tag antennas, movements into areas without PIT tag detectors (e.g., certain tributaries), or movements into tributaries that failed to reach PIT tag antennas.

## Preparing data

### Accessing PIT tag data

PIT tag data were obtained from the Columbia Basin PIT Tag Information System (PTAGIS). Only known-origin individuals (based on known release sites) were included in this dataset. To ensure that only individuals marked as juveniles were retained in the dataset, all individuals that were greater than 350 mm at time of marking were removed. To select returning adults, only individuals that were seen in the adult fishways at Bonneville Dam were selected. To ensure that there were enough data for each population included in this dataset, only populations (defined as tributaries in which PIT-tagged juveniles were released) that had at least 250 individuals distributed across 8 run years were retained. Additionally, only populations with instream PIT tag detections sites in their natal tributaries were retained; if sufficient instream detection sites only became available during the later part of our study period, only individuals from those years were retained. Run years were separated by June 1 of each year, and run year 2005/2006 (beginning on June 1, 2005) was selected as the first year in our dataset. In total, populations from 17 natal tributaries met these criteria: 11 tributaries of the Columbia (Deschutes River, John Day River, Hood River, Fifteenmile Creek, Umatilla River, Yakima River, Walla Walla River, Wenatchee River, Entiat River, Okanogan River, and Methow River) and six tributaries of the Snake (Tucannon River, Asotin Creek, Clearwater River, Salmon River, Grande Ronde River, and Imnaha River). Once the tag codes were identified for each of these tributary populations, a complete tag history report was run in PTAGIS for all of the tag codes in our dataset.

### Processing PIT tag data into detections at various sites

To convert detections of fish at individual PIT tag antennas into a history of movements between different reaches of the Columbia, Snake, and their tributaries, it was first necessary to interpret detections at different PIT tag antennas. For instream tributary detection sites, as well as mainstem sites in between dams, processing only entailed assigning detections at these sites to the corresponding model state. For detection sites at dams, more involved processing was required to interpret detections.

<br>

The first step in interpreting detections at dams was to identify the multiple passage routes associated with each dam. In many cases, multiple passage routes were grouped together into a single interrogation site, and assigning antennas to these different passage routes was necessary to interpret how fish were utilizing these passage routes. For example, antennas at Ice Harbor Dam are all grouped together in PTAGIS as "Ice Harbor Dam (combined)", when these antennas are actually in three different passage routes: the North Shore Ladder, the South Shore Ladder, and the Juvenile Bypass System.

<br>

The second step was to identify, when possible, entrance and exit antennas within each upstream passage route. By distinguishing entrance and exit antennas, we were able to identify when fish detections in adult fishways were not ascents, but were rather aborted ascent attempts or descents. Entrance and exit antennas were only distinguished when either two distinct groupings of antennas existed in separate parts of the same passage route, or in the case of Bonneville Dam, when there are enough consecutive weirs with PIT tag detection antennas to separate the antennas in these weirs into entrance and exit antennas. When fish were only seen at entrance antennas, this was noted to be an aborted ascension attempt. When fish were first seen at the exit antennas at an adult fish ladder and last seen at the entrance antennas of the same fish ladder, this was noted to be a descent through the ladder. If a fish was first seen at the entrance antennas and last seen at the exit antennas, this was noted to be an ascent. Entrance and exit antennas were identified at all adult fishways except for McNary Dam Washington Shore Ladder (prior to March 2006), Priest Rapids Dam, Rock Island Dam, Rocky Reach Dam, Wells Dam (prior to 2013), and Ice Harbor Dam.

<br>

Additionally, we identified antennas in adult fish facilities/traps at ladders. For most dams (e.g., Ice Harbor Dam, Priest Rapids Dam, or Lower Granite Dam, where traps were operated but adults were returned after processing), we treated detections in the adult fish facility the same as detections in other parts of the adult ladder, as adults were not removed. However, in the case of Wells Dam, trapped fish were either moved to the hatchery or trucked off-site. As such, any terminal detections in the trap at Wells Dam were classified as terminal trapping events, and were classified as fish moving to the absorbing "loss" state.

<br>

Once the antennas had been appropriately assigned, a 48-hour threshold was used to distinguish separate detection events at a site. However, in some passage routes fish were observed in the same route for days at a time, so no time threshold was set, and instead we used the sequence of antennas to distinguish separate detection events at a site. For example, some individual fish did not exit the Washington shore passage route at Bonneville Dam for upwards of 100 days, so new visits to this site were only distinguished by new visits to the entrance antennas, regardless of the amount of time between detections at other antennas in the passage route.

### Turning detections at different sites into state transitions

With antennas appropriately assigned to different passage routes and the sequence of antenna detections at the adult fishways used to interpret directionality, the output from the previous script was used as input into the next script, which converted a history of detections at sites into a history of movements between states, as defined in Fig. 2. For detections at sites in the fish passage routes at dams, the directionality of movement, as assigned in the previous script, was used to inform transitions between states. Ascents at dams indicated a transition from the downstream state to the upstream state; descents at dams (either through the juvenile bypass system or descents through the ladder) indicated a transition from the upstream state to the downstream state. Aborted ascension attempts were noted, but interpreted as no transition from the current state. Detections in tributary sites that immediately followed detections in mainstem sites were interpreted as transitions from the mainstem state into the tributary. Once a fish transitioned into a given state, any subsequent detections in that state were ignored, as they did represent transitions between states. Therefore, if fish were detected at sites within the same tributary consecutively, or if fish were detected at instream sites in the mainstem following transition into that mainstem state, these detections were ignored.

<br>

With the exception of a few downstream routes, such as the spillway at Lower Granite Dam following the installation of the PIT tag antennas in 2020, or the Bonneville Corner Collector, PIT tag detection capabilities at each dam were limited to the adult fish ladders and the juvenile bypass system. As such, PIT tag antennas have historically been unable to directly monitor fallback at dams, unless an individual subsequently reascends the dam [@Boggs2004]. With the installation of instream antennas in natal tributaries, fallback to home has been monitored [@Richins2018] by noting when individuals entered natal tributaries downstream of a dam that was previously ascended. In this study, we monitored fallback to the greatest extent possible with the current configuration of PIT tag antennas by using our knowledge of the connections between states in our model to note when downstream movements must have occurred. For example, if we noted two consecutive ascents at Bonneville Dam, or if we observed a fish in the John Day River after ascending McNary Dam, we added a fallback event in between these events. In this way, we included fallback that occurred on the mainstem downstream of the natal tributary (similar to @Boggs2004), fallback to home (similar to @Richins2018), and other fallback movements, such as fallback upstream of the natal tributary that did not end in homing. Using a similar strategy of interpolating state transitions based on state connectivity, we also interpolated upstream movements that were missed by the PIT tag antennas in adult fish ladders, although these missed detections were very infrequent, as detection probabilities in adult ladders is close to 100% [@Richins2017].

<br>

Once we determined a history of movement between states, we then subset this movement history to eliminate any movement that occurred as a juvenile or as a kelt in order to isolate only the portion of the adult migration prior to reaching spawning areas. Based on manual inspection of detection histories, juvenile movements were identified using the following criteria: (1) any detections within 90 days of juvenile release; (2) any detections on or before June 15 of the same year that an individual was released, or detections on or before June 15 in a given year if individual was released on or after July 1 of the previous year. The June 15 cutoff date was chosen based on the timing of juvenile outmigration at Bonneville Dam, 95% of which occurs before this date in nearly every run year (data from CBR DART). Kelt movement was identified as any downstream movement occurring between March and July (following spawning). Repeat spawners were also identified in the dataset based on detections at the Bonneville Dam adult ladders occurring at least 180 days after they were initially seen at Bonneville Dam. For the purposes of our analysis, repeat spawners were treated as new fish when they returned to Bonneville Dam.

## Statistical methods

### Modeling detection efficiency in tributaries

Over the course of our study period, the network of PIT tag detection arrays in tributaries was highly dynamic, as antennas were installed, decommissioned, and upgraded. From 2010 to 2018, the number of tag detection arrays in tributaries almost tripled [@Morrisett2018], and in some years of our study, the tributaries in our model had no active antennas at all [@Richins2017]. As a consequence, our ability to detect fish entering these tributaries varied considerably both temporally and spatially (between tributaries).

<br>

To address this, we estimated detection efficiency in tributaries by calculating the detection efficiency at the PIT tag detection site closest to the river mouth (i.e., the confluence of the tributary with either the Columbia or Snake River). We estimated detection efficiency by taking the individuals that were seen at detection sites upstream of the river mouth site and calculating what proportion were seen at the river mouth site. For 14 of the 17 tributaries in our model (Table 1), we identified a PIT tag detection site on the mainstem tributary suitable for calculating detection efficiency; three tributaries (the Clearwater River, Salmon River, and Grande Ronde River) lacked a suitable site and therefore detection efficiency was not calculated for these tributaries.

<br>

In our estimation of detection efficiency, we included two covariates: (1) a categorical covariate representing different antenna configurations, and (2) a covariate for the effect of discharge. Different categorical covariates were chosen based on the operational history of each interrogation site. We identified major changes in site configuration which were likely to have affected the detection efficiency at these sites, such as the installation of new antennas, arrays being moved, or components being upgraded. The years in which these changes occurred were then used to inform which categorical covariate for antenna configuration was used. We chose to include discharge as a covariate for detection efficiency as well because of the relationship between discharge and river stage, which affects the volume of the river covered by the range of the antennas (see Fig. 3 for an example). Discharge data were queried from USGS by finding the station on the interactive USGS dashboard (https://dashboard.waterdata.usgs.gov) closest the river mouth array and navigating to the data page for the specific site. Discharge data were available for all tributaries except Fifteenmile Creek and the Imnaha River; these tributaries therefore had detection efficiency estimated only via the categorical covariate (intercept) for antenna configuration.

<br>

![Figure 3. Hood River Mouth Array, configuration as of July 21, 2022. Green lines indicate the approximate low water line, while red lines indicate the approximate high water line. Note that at the high water line, 2/3 of the river channel is not covered by the PIT tag antennas. Figure from PTAGIS (https://www.ptagis.org/Sites/InterrogationSites?code=HRM).](.//figures/hood_river_site.png){width=130%}

<br>
<br>  
<br>

```{r det_eff_cat_changes, echo = FALSE, warning = FALSE, message = FALSE}
tributaries <- gsub("_", " ", natal_origin_order)

trib_cat <- data.frame(Tributary = c("Hood River", "Fifteenmile Creek", "Deschutes River",
                                     "John Day River", "Umatilla River", "Umatilla River",
                                     "Walla Walla River", "Walla Walla River", "Walla Walla River",
                                     "Yakima River", "Wenatchee River", "Entiat River",
                                     "Methow River", "Methow River", "Okanogan River",
                                     "Tucannon River", "Tucannon River", "Asotin Creek",
                                     "Asotin Creek", "Imnaha River"),
                       Years = c("15/16-21/22", "12/13-18/19", "12/13-19/20",
                                 "12/13-21/22", "07/08-13/14", "14/15-21/22",
                                 "05/06-11/12", "12/13-18/19", "19/20-21/22",
                                 "04/05-21/22", "10/11-21/22", "07/08-21/22",
                                 "09/10-16/17", "17/18-21/22", "12/13-21/22",
                                 "10/11-19/20", "20/21-21/22", "11/12-17/18",
                                 "18/19-21/22", "12/13-21/22"),
                       Site = c("Hood River Mouth (HRM)", "Fifteenmile Ck at Eighmile Ck (158)", "Deschutes River Mouth (DRM)",
                                "John Day River, McDonald Ferry (JD1)", "Three Mile Falls Dam (TMF)", "Three Mile Falls Dam (TMF)",
                                "Oasis Road Bridge (ORB)", "Walla Walla R at Pierce RV Pk (PRV)", "Walla Walla River Barge Array (WWB)",
                                "Prosser Diversion Dam (PRO)", "Lower Wenatchee River (LWE)", "Lower Entiat River (ENL)",
                                "Lower Methow River at Pateros (LMR)", "Lower Methow River at Pateros (LMR)", "Lower Okanogan Instream Array (OKL)",
                                "Lower Tucannon River (LTR)", "Lower Tucannon River (LTR)", "Asotin Creek Mouth (ACM)",
                                "Asotin Creek Mouth (ACM)", "Lower Imnaha River ISA @ km 7 (IR1)"),
                       Configuration = c("Initial", "Initial", "Initial",
                                         "Initial", "Initial", "Antenna installation at entrance to adult ladder",
                                         "Initial", "Initial", "Initial",
                                         "Initial", "Initial", "Initial",
                                         "Initial", "Site was moved 5 km upstream and tranceivers replaced", "Initial",
                                         "Initial", "All antennas replaced, additional antenna installed", "Initial",
                                         "All components replaced and upgraded", "Initial"))

flextable(trib_cat) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Tributary PIT tag antenna configurations used in detection efficiency estimation.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage()
```

<br>
<br>  
<br>

Detection efficiency was then estimated using a logistic regression, with detection a function of an intercept for the categorical covariate of site configuration, and a slope term (unique to each tributary) multiplied by the mean discharge in that run year.
\usepackage{amsmath}
<br>

$$
z_{i} \sim \text{Bernoulli}(p_{i})
$$
$$
\text{logit}(p_i)=\alpha_{j, k}  +  \beta_{j}  discharge_{j,t}
$$

In this equation, $z$ is whether or not an individual fish was detected (0 or 1), $p$ is the probability of detection, $\alpha$ is the categorical covariate for site configuration, and $\beta$ is the slope for the effect of discharge on the probability of detection efficiency.

The indices represent the following:

- $i$ is the individual fish
- $j$ is the tributary
- $k$ is the site configuration (a categorical variable)
- $t$ is the run year

A Stan [@Carpenter2017] model was used to estimate detection probability in each tributary. Discharge values were Z-scored prior to the model being fit. The posteriors from this model for each of the $\alpha$ (site configuration covariates) and $\beta$ (effect of discharge) terms were used as priors in the primary Stan model that was used to estimate movement. The fit for detection efficiency for each tributary can be found in Appendix 1.

### Movement model

The history of state transitions for each individual PIT-tagged fish, as well as the information on that fish's natal origin, were the inputs for the current configuration of the multistate model. The multistate model was implemented in a Bayesian framework using the Stan programming language [@Carpenter2017]. The multistate model is constructed as a series of states, defined as either reaches of the mainstem Columbia or Snake Rivers between dams with active PIT tag antennas for the duration of our study period or tributaries that flow into the Columbia or Snake Rivers (Fig. 2). All fish in our model begin when they are first detected as adults in the fish ladders at Bonneville Dam. At each state in our model, each fish is assigned a probability of moving to any of the states connected to the current state, or into the absorbing loss category, which a fish enters once the detection history ends. Each of these probabilities was evaluated through a categorical logit model, with an intercept term (a grand mean, for all fish in the dataset) as well as a term for the origin of the fish. The loss probability was calculated as 1 - the sum of the other probabilities, enforcing a constraint that all movement probabilities have to sum to 1.

<br>

Due to the computational requirements of evaluating the detection histories of over 60,000 individual fish, the model was fit to three different datasets, corresponding to the three Steelhead DPSs found exclusively upstream of Bonneville Dam: the Middle Columbia DPS, the Upper Columbia DPS, and the Snake River Basin DPS. Within the datasets for each of the three DPSs, all individuals were pooled across years when fitting the model, generating movement probability estimates that did not vary annually. To reduce the number of parameters in the model, an effect of natal origin was only included for state transitions into or out of states within the DPS boundaries, whereas for states outside of the DPS, all origins shared a common movement probability. This model structure allowed different natal origins to differentiate as they neared natal tributaries. Each of the DPS models was run for 200 warmup and 200 sampling iterations; future model runs will use longer chain lengths, but shorter chain lengths were used for the model runs in this report because of the long run times of these models. Despite the relatively short chain lengths, the modeling results in this progress report are reliable, as diagnostic checks such as effective sample sizes, autocorrelation, and r hat values were all satisfied. All code is available at https://github.com/markusmin/steelhead.

<br>

For each transition of a fish out of a state, there are $n$ possible non-loss transitions out of the current state, which correspond to the number of arrows out of the state as seen in Fig. 2. The true probability ($p_{actual}$) of moving to state $m$ ($m$ = 1, ..., n) from the current state is given as follows:

<br> 

$$
p_{actual, m} = \frac{exp(b_{0,m} + b_{origin,m})}{1 + exp(b_{0,1} + b_{origin,1}) + exp(b_{0,2} + b_{origin,2}) + ... exp(b_{0,n} + b_{origin,n})}
$$
<br>

The loss term is given by the following equation:
$$
p_{actual,loss} = 1 - \sum_{m=1}^{n} p_{actual,m}
$$

<br> 

This generates a vector of probabilities, corresponding to the true movement probability from the current state to each of the connecting states. However, because perceived movement is a product of both the true movement and the detection probability of various PIT tag arrays, we must correct for this detection probability to separate our process of interest (the true movement probabilities, $p_{actual}$) from the observation process (the detection probability, $p_{detection}$). The product of $p_{actual}$ and $p_{detection}$ is $p_{observed}$, which is used to evaluate the likelihood of the observed PIT tag data. We only estimate $p_{detection}$ for tributaries in our model; $p_{detection}$ in adult fish ladders is assumed to be one, with any known missed detections interpolated (see section 3.3.3), and there is no way to estimate $p_{detection}$ in downstream mainstem passage routes.

<br> 

Once we have estimated $p_{actual}$, the detection efficiency correction is implemented for all transitions for which we can calculate a detection efficiency, to generate $p_{observed}$. Given that for almost every tributary, detection efficiency could not be calculated for every year, the first step was to identify which connecting states had the ability to estimate detection efficiency in the year in which the transition occurred. For each of the transitions for which a detection efficiency could then be estimated, the following correction was made: 

<br>

First, the detection efficiency of that tributary in that year ($t$), with that year's mean discharge, was estimated:

$$
p_{detection,j,t} = exp(\alpha_{j, k}  +  \beta_{j}  discharge_{j,t})/(1 + exp(\alpha_{j, k}  +  \beta_{j}  discharge_{j,t}))
$$

<br>

Next, the probability of the corresponding transition in the vector of observed transitions was adjusted:
$$
p_{observed,j} = p_{actual,j} * p_{detection,j,t}
$$

<br>

Since any transitions that were unobserved but occurred would appear as fish moving to the absorbing loss state, this movement probability was also adjusted accordingly for each of the $n$ tributaries that connect to that mainstem state:
$$
p_{observed,loss} = p_{actual, loss} + \sum_{j=1}^{n} p_{actual,j} * (1 - p_{detection,j,t})
$$

<br>

With the vector of observed transition probabilities generated, the likelihood of observing the next movement ($x$) of fish $z_i$ was defined as follows:
$$
z_{i,x} \sim \text{categorical}(p_{observed,1}, p_{observed,2}, p_{observed,3} ... p_{observed, n}, p_{observed, loss})
$$

<br>

In these equations, $p_{detection}$ is the probability of detection, $p_{actual}$ is the vector which contains the true movement probabilities, $p_{observed}$ is the vector which contains the observed movement probabilities, $\alpha$ is the categorical covariate for site configuration, $\beta$ is the slope for the effect of discharge on the probability of detection efficiency, and $z_{i,x}$ is the next observation of the fish. The indices represent the following:

- $i$ is the fish
- $x$ is the observation of fish $i$
- $m$ is the state
- $j$ is the tributary
- $k$ is the site configuration (a categorical variable)
- $t$ is the run year

### Derived model probabilities

#### Final population distribution (final fates)

From the movement probabilities estimated by the model, we estimated the probability of fish ending in each state in the model. This was done via a simulation approach, where for each natal origin, one million fish of that origin started in the state directly upstream of Bonneville Dam. The simulation then ran forward in time, selecting the next state of each fish based on the model-derived probabilities of movement, until each fish entered the loss state. The state directly prior to the loss state was recorded as the "final fate" of the fish, and the proportion of fish that ended in each state was calculated. Credible intervals were generated for these final fates by re-running the simulation with each of the MCMC draws for each parameter, with the 2.5th and 97.5th quantiles of the final fates presented.

#### Homing probabilities, conditional on overshoot

To assess the effect of overshooting on eventual homing success, as defined by the final fate of a fish being its natal tributary, the simulation approach outlined above was similarly implemented, but with a different starting state. The probability of homing was compared for fish which started in the state that connected to the home tributary and for fish which started in the first overshoot state. These two probabilities were compared by computing the ratio of the probability of homing for overshooting and non-overshooting fish and then calculating the 95% credibility interval around this ratio.

# Results

## Summary statistics


### Sample sizes

```{r fish_table_load, echo = FALSE, message = FALSE, warning = FALSE}
read.csv(here::here("CBR_report", "CBR_report_final", "tables", "fish_year_origin_table.csv"), row.names = 1) -> fish_year_origin_table

fish_year_origin_table[match(natal_origin_order, fish_year_origin_table$natal_origin),] -> fish_year_origin_table

fish_year_origin_table %>% 
  mutate(natal_origin = gsub("_", " ", natal_origin)) -> fish_year_origin_table

colnames(fish_year_origin_table) <- c("Natal Origin", "05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22")
```

A total of 61,220 PIT-tagged fish were in our dataset, distributed across `r ncol(fish_year_origin_table) - 1` run years. The three natal origins with the most fish were the Salmon River, the Methow River, and the Grande Ronde River.

<br>
```{r fish_table_print, echo = FALSE, message = FALSE, warning = FALSE}
flextable(fish_year_origin_table) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Number of tagged fish in our dataset, by natal origin and run year.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 9, part = "body") %>% 
  fontsize(size = 8, part = "header") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage()
```

<br>


### Out-of-DPS movement

Snake River Basin Steelhead were seen in the Upper Columbia (upstream of Priest Rapids Dam) much more often than Upper Columbia Steelhead were seen in the Snake River (upstream of Ice Harbor Dam). The Upper Columbia natal origin which was most often seen in the Snake River was the Methow River, but only 5 individuals (comprising 0.06% of the 7,996 tagged individuals from this natal origin) were seen in the Snake River. In contrast, 3.37% of Asotin Creek Steelhead (19 of 564 tagged individuals) and 2.09% of Imnaha River Steelhead (106 of 5,060 tagged individuals) were seen upstream of Priest Rapids Dam. Middle Columbia Steelhead, especially Walla Walla River Steelhead, were seen in either the Snake River or the Upper Columbia very frequently; these fish were individuals that overshot their home tributary. 

<br>

```{r out_of_DPS, echo = FALSE, message = FALSE, warning = FALSE}
read.csv(here::here("CBR_report", "CBR_report_final", "tables", "out_of_ESU_counts_table.csv"), row.names = 1) -> out_of_ESU_counts_table

out_of_ESU_counts_table[match(natal_origin_order, out_of_ESU_counts_table$natal_origin),] -> out_of_ESU_counts_table

out_of_ESU_counts_table %>% 
  mutate(natal_origin = gsub("_", " ", natal_origin)) %>% 
  dplyr::rename("Natal Origin" = natal_origin, "Sample Size" = total, "Number observed outside of DPS" = n, "Percent" = percent) -> out_of_ESU_counts_table

# Let's remove the Hood River for now, since it's in the Lower Columbia DPS
out_of_ESU_counts_table <- subset(out_of_ESU_counts_table, `Natal Origin` != "Hood River")


flextable(out_of_ESU_counts_table) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Number and percent of tagged individuals seen in reaches of the Columbia or Snake outside of the DPS boundaries that are not necessary for homing. For Middle Columbia Steelhead, this is defined as reaches upstream of Priest Rapids Dam on the Columbia River or upstream of Ice Harbor Dam on the Snake River; for Upper Columbia Steelhead, this is defined as reaches upstream of Ice Harbor Dam on the Snake River, and for Snake River Basin Steelhead, this is defined as reaches upstream of Priest Rapids Dam on the Columbia River.")  %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage()
```


### Overshoot by dam

Overshooting was most frequently observed in John Day River Steelhead (55% of tagged individuals overshot McNary Dam), Umatilla River Steelhead (40% of tagged individuals overshot McNary Dam), Wenatchee River Steelhead (47% of tagged individuals overshot Rocky Reach Dam), Entiat River Steelhead (35% of tagged individuals overshot Wells Dam), and Walla Walla River Steelhead (52% of tagged individuals overshot Ice Harbor Dam). Two populations were observed to overshoot at least two dams at a frequency higher than 20%: Walla Walla River Steelhead (Ice Harbor Dam and Lower Granite Dam) and Wenatchee River Steelhead (Rocky Reach Dam and Wells Dam). Middle Columbia Steelhead tended to overshoot at Ice Harbor Dam more frequently than at Priest Rapids Dam, with the exception of Yakima River Steelhead, which can be explained by the Yakima River confluence with the Columbia River being upstream of the confluence of the Columbia and Snake Rivers. 

<br> 

```{r overshoot_table, echo = FALSE, message = FALSE, warning = FALSE}
read.csv(here::here("CBR_report", "CBR_report_final", "tables", "overshoot_dam_origin_table.csv"), row.names = 1) -> overshoot_dam_origin_table

overshoot_dam_origin_table[is.na(overshoot_dam_origin_table)] <- "NA"

overshoot_dam_origin_table[match(natal_origin_order, overshoot_dam_origin_table$natal_origin),] -> overshoot_dam_origin_table

overshoot_dam_origin_table %>% 
  mutate(natal_origin = gsub("_", " ", natal_origin)) %>% 
  dplyr::rename("Natal Origin" = natal_origin) -> overshoot_dam_origin_table


flextable(overshoot_dam_origin_table) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Proportion and number of tagged individuals observed overshooting each dam. NA values indicate dams that are not overshoot dams for that natal origin.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage()
```


### Fallback by dam

Fallback at dams was not observed directly, but rather was inferred by the remainder of the detection history. Due to detection efficiency in fallback routes being less than one, but also not estimable, these are lower bound estimates of fallback. Many natal origins had high proportions of individuals falling back over at least one dam. More than 20% of PIT-tagged John Day River Steelhead, Umatilla River Steelhead, and Entiat River Steelhead had at least one known fallback event, the majority of which were post-overshoot fallback events. By dam, McNary Dam had the highest number of fish observed to fall back over it (2,480), followed by Lower Granite Dam (1,440), Ice Harbor Dam (1,184), and Bonneville Dam (1,148).

<br>

```{r fallback_table, echo = FALSE, message = FALSE, warning = FALSE}
read.csv(here::here("CBR_report", "CBR_report_final", "tables", "fallback_dam_origin_table.csv"), row.names = 1) -> fallback_dam_origin_table

fallback_dam_origin_table[is.na(fallback_dam_origin_table)] <- "NA"

fallback_dam_origin_table[match(natal_origin_order, fallback_dam_origin_table$natal_origin),] -> fallback_dam_origin_table

fallback_dam_origin_table %>% 
  mutate(natal_origin = gsub("_", " ", natal_origin)) %>% 
  dplyr::rename("Natal Origin" = natal_origin) -> fallback_dam_origin_table


flextable(fallback_dam_origin_table) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Proportion and number of tagged individuals observed falling back at each dam. Highlighted cells are post-overshoot fallback, whereas non-highlighted cells are en-route fallback. NA values indicate a dam that no fish of that natal origin ascended.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  # highlight the post-overshoot fallback
  # style(i = 2, j = 3:4, 
  #       pr_t = fp_text_default(
  #         shading.color = "yellow")) %>% 
  highlight(i = ~`Natal Origin` == "Hood River", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Hood River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Hood River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Hood River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Hood River", j = ~ WEL, color = "wheat") %>%
  # highlight(i = ~`Natal Origin` == "Hood River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Hood River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ MCN, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ MCN, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ LGR, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ LGR, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Entiat River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ LGR, color = "wheat") %>%
  highlight(i = ~`Natal Origin` == "Methow River", j = ~ ICH, color = "wheat") %>%
  highlight(i = ~`Natal Origin` == "Methow River", j = ~ LGR, color = "wheat") %>%
  highlight(i = ~`Natal Origin` == "Okanogan River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Okanogan River", j = ~ LGR, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ LGR, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ WEL, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ WEL, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ WEL, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Salmon River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Salmon River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Salmon River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Salmon River", j = ~ WEL, color = "wheat") %>% 
      highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ WEL, color = "wheat") %>% 
  FitFlextableToPage()
```

## Final population distribution probability

The final population distribution was extracted from model output for migrants from each natal origin, conditional on passing Bonneville Dam as an adult. The final population distribution probabilities are adjusted for detection efficiency to the extent that detection efficiency could be estimated; inadequate detection opportunities in the Clearwater River, Salmon River, and Grande Ronde Rivers resulted in negative bias of unknown size on distribution probabilities for those tributaries. Results are presented below categorized by DPS.

<br>

### Middle Columbia River Steelhead

Yakima River, Umatilla River, and Deschutes River Steelhead each had median homing probabilities of over 0.5, with Yakima River Steelhead having the highest homing probability of any of the six Middle Columbia Steelhead tributaries, with a homing probability of 0.77 (0.71 - 0.82). On the contrary, Fifteenmile Creek, John Day River, and Walla Walla River Steelhead all had median homing probabilities below 0.4. Each of these populations had varying final fate distributions. Fifteenmile Creek Steelhead had a 0.23 (0.19 - 0.3) probability of ending in the mainstem between Bonneville and McNary Dams (the mainstem state which connects to Fifteenmile Creek), but actually had a higher median probability of ending up in the Deschutes River (0.44, 95% CI 0.36 - 0.53) than in Fifteenmile Creek (0.27, 95% CI 0.22 - 0.34). John Day River and Walla Walla River Steelhead, which both had an overshoot frequency of over 50% (Table 4), had a final fate distribution where the probability was distributed over more states. John Day River Steelhead had a 0.36 (0.33 - 0.40) probability of homing to the John Day River, a 0.09 (0.07 - 0.12) probability of ending in the Deschutes River, a 0.25 (0.23 - 0.28) probability of ending in the mainstem between Bonneville and McNary Dams (the mainstem state which connects to the John Day River), and a 0.16 (0.14 - 0.17) probability of ending in the mainstem state directly upstream of McNary Dam, which represents an overshoot state for this population. Walla Walla River Steelhead had a 0.37 (0.29 - 0.39) probability of homing to the Walla Walla River, a 0.17 (0.15 - 0.18) probability of ending in the mainstem between Bonneville and McNary Dams (the mainstem state which connects to the Walla Walla River), a 0.19 (0.17 - 0.21) probability of ending in the mainstem state between Ice Harbor and Lower Granite Dams (the first overshoot state on the Snake River), a 0.14 (0.13 - 0.15) probability of ending in the mainstem upstream of Lower Granite Dam (the second overshoot state on the Snake River), and a 0.08 (0.07 - 0.09) probability of straying to the Tucannon River (which is upstream of Ice Harbor Dam).

<br>

![Figure 4. Fifteenmile Creek Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/fifteenmile_fates_plot.pdf){width=100%}

![Figure 5. Deschutes River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/deschutes_fates_plot.pdf){width=100%}

![Figure 6. John Day River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/john_day_fates_plot.pdf){width=100%}

![Figure 7. Umatilla River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/umatilla_fates_plot.pdf){width=100%}

![Figure 8. Walla Walla River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/walla_walla_fates_plot.pdf){width=100%}

![Figure 9. Yakima River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/yakima_fates_plot.pdf){width=100%}

### Upper Columbia River Steelhead

Wenatchee River Steelhead only had a roughly 1/3 probability of homing successfully, whereas the other three origins had median homing probabilities between 0.4 and 0.6. Wenatchee River Steelhead had high probabilities of ending in overshoot mainstem states upstream of the Wenatchee, notably the reach upstream of Well's Dam (0.17, 95% CI 0.16-0.18) and the reach between Rocky Reach Dam and Well's Dam (0.09, 95% CI 0.08-0.09). Entiat River Steelhead had a less than 0.1 probability of ending in any of the mainstem states on the Upper Columbia, while Methow River and Okanogan River Steelhead had 0.19 (0.17 - 0.21) a nd 0.13 (0.09 - 0.16) probabilities of ending in the rech upstream of Wells' Dam, which connects to both of their natal tributaries. While Methow River Steelhead had a 0.05 probability of straying to the Okanogan River, the other three origins had a 0.03 - 0.04 median probability of straying to the Methow River. The probability of straying to any other tributary was nearly zero, except for the Deschutes River, which had a probability around 0.01 for all natal origins.

<br>

All Upper Columbia Steelhead had an estimated 0.22 (0.22 - 0.23) probability of only making it to the reach between Bonneville Dam and McNary Dam; however, this final fate is most representative of Methow River and Wenatchee River Steelhead due to their larger sample sizes and the shared movement probabilities in this reach of the Columbia River for all natal origins within this DPS (see Discussion section 5.1.2 for detail on this limitation).

<br>

![Figure 10. Wenatchee River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/wenatchee_fates_plot.pdf){width=100%}

![Figure 11. Entiat River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/entiat_fates_plot.pdf){width=100%}

![Figure 12. Methow River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/methow_fates_plot.pdf){width=100%}

![Figure 13. Okanogan River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/okanogan_fates_plot.pdf){width=100%}

### Snake River Basin Steelhead

Because three of the six Snake River tributaries could not be corrected for detection efficiency, homing probabilities for these three tributaries (the Clearwater River, Grande Ronde River, and Salmon River) are biased low, as are straying probabilities of the other three origins into these three tributaries. Fish from these three natal origins each had a median probability of last being seen upstream of Lower Granite Dam (the state which connects to these tributaries) of over 0.5; many of the fish which were last seen in this state likely reached natal tributaries but were not detected. The three tributaries for which detection efficiency could be estimated had varying homing probabilities: while the probability of homing for Asotin Creek individuals was 0.59 (0.53 - 0.64), the homing probability was lower for Imnaha River Steelhead at 0.44 (0.42 - 0.45), and lowest for Tucannon River Steelhead at 0.33 (0.31 - 0.36). Tucannon River Steelhead had high overshoot frequency at Lower Granite Dam (Table 4), and consequently these fish had a high probability of last being seen upstream of Lower Granite Dam, with a 0.25 (0.24 - 0.27) probability of ending in this state. Imnaha River Steelhead had a high probability of last being seen upstream of Lower Granite Dam (0.27, 0.25 - 0.28); some of these fish may have strayed to tributaries either without PIT tag antennas or into the aforementioned tributaries that did not have the ability to correct for detection efficiency.

<br>

All Snake River Basin Steelhead had an estimated 0.20 (0.19 - 0.20) probability of only making it to the reach between Bonneville Dam and McNary Dam; however, this final fate is skewed towards natal origins in this DPS with large sample sizes (e.g., the Salmon River) due to the shared movement probabilities in this reach of the Columbia River for all natal origins within this DPS (see Discussion section 5.1.2 for detail on this limitation).

<br>

![Figure 14. Tucannon River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/tucannon_fates_plot.pdf){width=100%}

![Figure 15. Clearwater River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/clearwater_fates_plot.pdf){width=100%}

![Figure 16. Asotin Creek Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/asotin_fates_plot.pdf){width=100%}

![Figure 17. Grande Ronde River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/grande_ronde_fates_plot.pdf){width=100%}

![Figure 18. Salmon River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/salmon_fates_plot.pdf){width=100%}

![Figure 19. Imnaha River Final Fate Probabilities. Point estimates show the median value, with the intervals showing the 95% credible interval.](.//figures/final_fates_plots/imnaha_fates_plot.pdf){width=100%}

## Homing probabilities, conditional on overshoot

Overshooting dams considerably reduced homing probability, with an average associated drop in homing probability of around 50% across the 9 natal origins for which overshoot could be estimated (Table 6). For some natal origins, this reduction was modest. For example, most Yakima River and Entiat River Steelhead that overshot still were most likely to make it home. For other natal origins, the effect of overshooting was dramatic: the probability of homing for Wenatchee River Steelhead that did not overshoot was nearly four times that of individuals that did (Table 6). Interestingly, for Yakima River and Walla Walla River Steelhead, which could overshoot at Priest Rapids Dam or Ice Harbor Dam, for both tributaries overshooting Ice Harbor Dam led to a lower probability of successfully homing than did overshooting Priest Rapids Dam.

<br>

```{r homing_probs, echo = FALSE, warning = FALSE, message = FALSE}
read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "overshoot_homing_probabilities.csv"), row.names = 1) %>% 
  dplyr::rename("Natal Origin" = natal_origin, "Non-overshoot" = non_overshoot, "Overshoot" = overshoot, "Ratio" = overshoot_ratio) -> overshooting_homing_probs

flextable(overshooting_homing_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "A comparison of the probability of successfully homing, conditional on either (1) making it to the section of mainstem into which the home tributary flows (Non-overshoot), or (2) on overshooting the dam directly upstream of the home tributary (Overshoot), with the ratio of the probability of homing for  overshoot to non-overshoot. Point estimates show the median value, with the intervals showing the 95% credible interval.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage()
```

## Overshoot probability by dam and origin

Overshoot probabilities were high for John Day River, Umatilla River, Wenatchee River, Entiat River, and Tucannon River Steelhead, reflecting the data presented in Table 4. Across all DPSs, a pattern emerges where for natal origins where the probability of overshoot of the first dam upstream of the natal tributary is low, the probability of overshooting subsequent dams is considerably higher. For example, although uncertainty is high, in Middle Columbia Steelhead (Table 7), natal origins outside of the Yakima River and Fifteenmile Creek have an overshoot probability at Priest Rapids of 0.01-0.04; however, for subsequent upstream dams on the Columbia, these probabilities are in the range of 0.3 - 0.5. A similar pattern is seen for Upper Columbia Steelhead at Ice Harbor and Lower Granite Dams on the Snake River (Table 8), and for Priest Rapids Dam and subsequent dams on the Upper Columbia for Snake River Basin Steelhead (Table 9).

<br>
  
```{r overshoot_probs, echo = FALSE, warning = FALSE, message = FALSE}
read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "dam_specific_overshoot_probs.csv"))  -> dam_specific_overshoot_probs

dam_specific_overshoot_probs %>% 
  mutate(origin = ifelse(origin == "Grande Ronde", "Grande Ronde River", origin)) %>% 
  dplyr::rename("Natal Origin" = origin) -> dam_specific_overshoot_probs

dam_specific_overshoot_probs[match(gsub("_", " ",natal_origin_order), dam_specific_overshoot_probs$`Natal Origin`),] -> dam_specific_overshoot_probs

# For all dam + origin combinations where we never observed overshoot, change those to zeros
dam_specific_overshoot_probs[1,c('PRA', 'RIS', 'RRE', 'WEL')] <- "NA" # Fifteenmile Creek
dam_specific_overshoot_probs[2,c('PRA', 'RIS', 'RRE', 'WEL')] <- "NA" # Deschutes River
dam_specific_overshoot_probs[8,c('ICH', 'LGR')] <- "NA" # Entiat River


subset(dam_specific_overshoot_probs, `Natal Origin` %in% middle_columbia_origins) -> MC_dam_specific_overshoot_probs
subset(dam_specific_overshoot_probs, `Natal Origin` %in% upper_columbia_origins) -> UC_dam_specific_overshoot_probs
subset(dam_specific_overshoot_probs, `Natal Origin` %in% snake_origins) -> SN_dam_specific_overshoot_probs

# Split into three tables: Middle Columbia, Upper Columbia, and Snake River Basin

flextable(MC_dam_specific_overshoot_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Probability of overshooting a dam, conditional on being in the state directly downstream of the dam, for Middle Columbia River Steelhead. Point estimates show the median value, with the intervals showing the 95% credible interval. NA values are overshoot movements that were not observed for that specific natal origin. Blank cells are dam ascents that are not overshoot movements for that natal origin. Asterisks indicate overshoot probabilities that are shared across all natal origins within this DPS.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ MCN, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ PRA, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ RIS, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ RRE, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ MCN, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ PRA, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ RIS, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ RRE, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ RIS, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "John Day River", j = ~ RRE, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "John Day River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Yakima River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Yakima River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Yakima River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Yakima River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Yakima River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Yakima River", j = ~ LGR, color = "wheat") %>% 
  FitFlextableToPage()
```
<br>
```{r upper_columbia_overshoot_table, echo = FALSE, message = FALSE, warning = FALSE}

flextable(UC_dam_specific_overshoot_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Probability of overshooting a dam, conditional on being in the state directly downstream of the dam, for Upper Columbia River Steelhead. Point estimates show the median value, with the intervals showing the 95% credible interval. NA values are overshoot movements that were not observed for that specific natal origin. Blank cells are dam ascents that are not overshoot movements for that natal origin. Asterisks indicate overshoot probabilities that are shared across all natal origins within this DPS.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  # highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ WEL, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ WEL, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ ICH, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Methow River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Methow River", j = ~ LGR, color = "wheat") %>% 
  # # highlight(i = ~`Natal Origin` == "Okanogan River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Okanogan River", j = ~ LGR, color = "wheat") %>% 
  FitFlextableToPage()
```
<br>
```{r snake_river_basin_overshoot_table, echo = FALSE, message = FALSE, warning = FALSE}

flextable(SN_dam_specific_overshoot_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Probability of overshooting a dam, conditional on being in the state directly downstream of the dam, for Snake River Basin Steelhead. Point estimates show the median value, with the intervals showing the 95% credible interval. NA values are overshoot movements that were not observed for that specific natal origin. Blank cells are dam ascents that are not overshoot movements for that natal origin. Asterisks indicate overshoot probabilities that are shared across all natal origins within this DPS.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  # highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Salmon River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Salmon River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Salmon River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Salmon River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ WEL, color = "wheat") %>% 
  FitFlextableToPage()
```

## Fallback probability by dam and origin

Fallback probabilities for en-route fallback were generally considerably lower than post-overshoot fallback probabilities (Table 7). Median en-route fallback probabilities at each dam were mostly between 0.01 and 0.05. En-route fallback was most likely at McNary Dam.

<br>

```{r fallback_probs, echo = FALSE, warning = FALSE, message = FALSE}
read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "dam_specific_fallback_probs.csv"))  -> dam_specific_fallback_probs

dam_specific_fallback_probs %>% 
  mutate(origin = ifelse(origin == "Grande Ronde", "Grande Ronde River", origin)) %>% 
  dplyr::rename("Natal Origin" = origin) -> dam_specific_fallback_probs

# For all dam + origin combinations where we never observed fallback, change those to zeros
dam_specific_fallback_probs[1,c('PRA', 'RIS', 'RRE', 'WEL')] <- "NA" # Fifteenmile Creek
dam_specific_fallback_probs[2,c('PRA', 'RIS', 'RRE', 'WEL')] <- "NA" # Deschutes River
dam_specific_fallback_probs[3,c('RRE', 'WEL')] <- "NA" # John Day River
dam_specific_fallback_probs[7,c('ICH')] <- "NA" # Wenatchee River
dam_specific_fallback_probs[8,c('ICH', 'LGR')] <- "NA" # Entiat River
dam_specific_fallback_probs[9,c('ICH')] <- "NA" # Okanogan

dam_specific_fallback_probs[match(gsub("_", " ",natal_origin_order), dam_specific_fallback_probs$`Natal Origin`),] -> dam_specific_fallback_probs

subset(dam_specific_fallback_probs, `Natal Origin` %in% middle_columbia_origins) -> MC_dam_specific_fallback_probs
subset(dam_specific_fallback_probs, `Natal Origin` %in% upper_columbia_origins) -> UC_dam_specific_fallback_probs
subset(dam_specific_fallback_probs, `Natal Origin` %in% snake_origins) -> SN_dam_specific_fallback_probs

# Split into three tables: Middle Columbia, Upper Columbia, and Snake River Basin

flextable(MC_dam_specific_fallback_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Probability of falling back over a dam, conditional on being in the state directly upstream of the dam, for Middle Columbia River Steelhead. Highlighted cells are probabilities of post-overshoot fallback, whereas non-highlighted cells are probabilities of en-route fallback. Point estimates show the median value, with the intervals showing the 95% credible interval. NA values indicate fallback movements that were not observed for that specific natal origin. Asterisks indicate fallback probabilities that are shared across all natal origins within this DPS.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Fifteenmile Creek", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ MCN, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ PRA, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Deschutes River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ MCN, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ RIS, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ RRE, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "John Day River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "John Day River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ MCN, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Umatilla River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Walla Walla River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Yakima River", j = ~ LGR, color = "wheat") %>% 
  FitFlextableToPage()
```
<br>
```{r upper_columbia_fallback_table, echo = FALSE, message = FALSE, warning = FALSE}

flextable(UC_dam_specific_fallback_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Probability of falling back over a dam, conditional on being in the state directly upstream of the dam, for Upper Columbia River Steelhead. Highlighted cells are probabilities of post-overshoot fallback, whereas non-highlighted cells are probabilities of en-route fallback. Point estimates show the median value, with the intervals showing the 95% credible interval. NA values indicate fallback movements that were not observed for that specific natal origin. Asterisks indicate fallback probabilities that are shared across all natal origins within this DPS.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
    highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Wenatchee River", j = ~ LGR, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Entiat River", j = ~ WEL, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ ICH, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Entiat River", j = ~ LGR, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Methow River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Methow River", j = ~ LGR, color = "wheat") %>% 
  # highlight(i = ~`Natal Origin` == "Okanogan River", j = ~ ICH, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Okanogan River", j = ~ LGR, color = "wheat") %>% 
  FitFlextableToPage()
```
<br>
```{r snake_river_basin_fallback_table, echo = FALSE, message = FALSE, warning = FALSE}

flextable(SN_dam_specific_fallback_probs) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Probability of falling back over a dam, conditional on being in the state directly upstream of the dam, for Snake River Basin Steelhead. Highlighted cells are probabilities of post-overshoot fallback, whereas non-highlighted cells are probabilities of en-route fallback. Point estimates show the median value, with the intervals showing the 95% credible interval. NA values indicate fallback movements that were not observed for that specific natal origin. Asterisks indicate movement probabilities that are shared across all natal origins within this DPS.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
    highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ WEL, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Tucannon River", j = ~ LGR, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Clearwater River", j = ~ WEL, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Asotin Creek", j = ~ WEL, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Grande Ronde River", j = ~ WEL, color = "wheat") %>% 
    highlight(i = ~`Natal Origin` == "Salmon River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Salmon River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Salmon River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Salmon River", j = ~ WEL, color = "wheat") %>% 
      highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ PRA, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ RIS, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ RRE, color = "wheat") %>% 
  highlight(i = ~`Natal Origin` == "Imnaha River", j = ~ WEL, color = "wheat") %>% 
  FitFlextableToPage()
```



# Discussion

### Annual variability
Although our model does not explicitly account for the effect of run year on movement probabilities, annual variability in Steelhead movement patterns, particularly overshoot and fallback rates, has been documented among Steelhead [@Richins2018, @Keefer2008]. For example, @Richins2018 found that John Day River Steelhead that overshot McNary Dam had annual probabilities of fallback ranging from 25% to 75%. As covariates are added in future iterations of the model, we expect that this interannual variability will be partially explained by covariate values that describe the conditions experienced by fish in different run years, including spill, flow, and temperature. A random effect of year may also be included to capture this interannual variability that is poorly described by the fixed effects in our model.

### Consequences of model structure
To reduce the computational requirements of modeling our large dataset, as well as to estimate movement probabilities for transitions for which there was little available data, we only estimated origin-specific movement probabilities when fish were within the boundaries of their DPS, and estimated common movement probabilities for all fish of a DPS when they were outside of DPS boundaries. This allowed us to reduce the number of parameters that our model needed to estimate (thereby reducing computational requirements), and also allowed us to achieve estimates of certain infrequently seen movement probabilities by pooling data to inform movement probabilities of fish outside of their DPS, where they typically were seen less. The probabilities of overshoot and fallback presented in Tables 7-12 as well as the movement probabilities seen in Appendix 2 that are marked with an asterisk all were estimated jointly for all fish from a single DPS. This had three primary consequences: (1) natal origins within a DPS with the most tagged fish in our dataset were the most influential for DPS-wide movement probabilities, (2) any origin-specific variability in movement probabilities outside of DPS boundaries was ignored, and (3) movement probabilities were estimated for transitions never seen for some origins.

<br> 

The issue of varying sample size can be seen in Table 2, with the natal origin with the most fish (the Salmon River, with over 11,000 tagged Steelhead) having nearly 20 times the number of individuals as Asotin Creek (564), which is within the same DPS. Since all of these individual data points are weighted equally when calculating movement probabilities outside of the DPS, these movement probabilities are heavily skewed towards natal origins with many tagged fish. As such, the probabilities for movements that occur outside of DPS boundaries that are presented in Appendix 2, Tables 7-12, and in Figures 4-19, should be taken with a grain of salt. For each DPS, these probabilities are not representative of natal origins with less than 1,000 fish (Asotin Creek, Entiat River, Fifteenmile Creek, and the Yakima River) and are highly reflective of the movement probabilities of origins with over 5,000 fish (Clearwater River, Grande Ronde River, Imnaha River, Methow River, and Salmon River). While there may be some benefit of using data from data-rich stocks to inform the movement probabilities of data-poor stocks that are believed to be similar, as in the "Robin Hood" approach [@Punt2011], sample sizes play a large role in determining estimates of certain movement probabilities in our current model configuration. Future model configurations could be modified to allow differentiation between natal origins for movement probabilities that have plenty of data for all natal origins, such as movements in the Middle Columbia.

<br>

Even for natal origins that are well represented in the dataset, this simplification has obscured any variability between fish of natal origins when outside of DPS boundaries, which is likely most consequential for estimates of movement of Upper Columbia and Snake River Basin Steelhead when in the Middle Columbia River (downstream of McNary Dam). Previous studies have found important variability between natal origins for movements in this region. For example, @Hess2016 found that out-of-basin Steelhead seen in the Deschutes River were disproportionately from the Salmon River and Grande Ronde River. As such, cautious interpretation is necessary for our estimates of movement probabilities for Snake River Basin and Upper Columbia River Steelhead downstream of McNary Dam, as these differences between natal origins are not reflected in these estimates of movement.

<br>

Finally, movement probabilities are presented in Appendix 2 for some movements that were never observed for fish of a natal origin, and should be interpreted with great caution. These movement probabilities were removed in the tables in the main text. These can be best thought of as our best guess for the probability of movements, should a fish of that natal origin make it to that reach of the Columbia River Basin, as informed by movements of other fish from the same DPS but different natal origins.

### Detection probabilities in downstream passage routes
Steelhead fallback is difficult to monitor using PIT tags because of the lack of detection capabilities in the primary downstream passage routes for Steelhead, which include spillways, the Juvenile Bypass System (JBS), navigation locks, ice/trash sluiceways, and turbines. While some passage routes, such as the JBS, the corner collector at Bonneville Dam, and as of 2020, the spillway at Lower Granite Dam, have PIT tag detection capability, the majority of downstream movements are only detected by examining the rest of the detection history. For example, @Boggs2004 used consecutive detections in the same adult fish ladder to monitor rates of fallback, whereas @Richins2018 calculated fallback to home following overshoot as detections in tributaries following detections in the adult fish ladder at a dam upstream of the tributary. Our modeling framework includes both of these ways of detecting fallback, but this is still an underestimate of total fallback. Fallback such as fallback that leads to mortality cannot be detected using PIT tags, and any time a fish is not seen after fallback (i.e., either due to a fish entering a tributary with PIT tag arrays but not being detected, entering a tributary without PIT tag arrays, spawning in the mainstem, or mortality following fallback), the fallback event will not be observed. As such, the current network of PIT tag arrays is incapable of monitoring all fallback and estimates of fallback from this model should be interpreted as lower bound estimates. However, the current modeling framework gives us the closest estimate of fallback possible using PIT tag data.

Our ability to estimate fallback at Lower Granite Dam likely improved with the 2020 installation of PIT tag antennas in the spillway; future analyses will evaluate the impact of this recent installation by comparing estimates of fallback at Lower Granite before and after the 2020 installation. Given the small sample size of only two years since the PIT antenna installation in the spillway, these results would have to be interpreted cautiously, given the environmental and operational factors that are likely to have impacted fallback at Lower Granite during this same time period. Nonetheless, this analysis will provide insight into how our ability to detect fallback is affected by spillway detectors, and may also indicate what degree of fallback is being missed at other dams without spillway PIT tag antennas.

## Next steps

### Adding additional covariates
The model structure and the use of the categorical logit to evaluate movement probabilities allows for the inclusion of both categorical and continuous covariates in the model. The next covariates that we plan to include in future iterations of the model are rear type (hatchery or wild), temperature (mainstem temperatures from dam tailraces), flow, and spill. We are also considering the addition of covariates related to juvenile experiences (barged vs. not barged, acclimated vs. not acclimated hatchery releases). Some of these covariates, especially rear type, have been found to be a major predictor of homing success [@Richins2018], and as such the reader should be aware that these differences are not being captured in the current iteration of the model. The inclusion of these continuous covariates will further our understanding of what environmental conditions (e.g., temperature or flow conditions) lead to increased probability of Steelhead choosing more dangerous migration pathways to natal tributaries, such as overshooting natal tributaries. The inclusion of covariates that can be influenced by hydropower managers (e.g., spill or flow) or fishery managers (e.g., hatchery practices or assisted juvenile migration) would help inform how we can help Steelhead return safely to natal tributaries. Given the increased interest in assisting downstream Steelhead passage, such as via spill practices [@Ham2021], the inclusion of these covariates would improve our understanding of how to help recover these populations by informing management practices.

### Increasing model state complexity
As mentioned previously, the current iteration of the model does not use The Dalles Dam or John Day Dam to separate states, and therefore the probability of fallback and overshoot at these dams is not being estimated. However, future model iterations could include these dams either by creating a new model that only uses years of data where these dams had PIT tag detectors in the adult fishways, or by modifying the existing model to turn on or off these states, depending on the run year (similar to the current approach with tributary detection efficiency). This would help achieve a better estimate of the true burden of overshoot and fallback throughout the Columbia River Basin, and would be of particular interest for tributaries close to these dams (e.g., Fifteenmile Creek, Deschutes River, and John Day River Steelhead). 

# Management implications
The ability of this modeling framework to incorporate various covariates of interest will allow us to answer a number of pressing management questions surrounding Steelhead overshoot and fallback. For example, winter spill could be included, either as a continuous variable (e.g., amount of spill), a categorical variable (spill or no spill), or an ordinal variable (days of spill). This would allow us to determine what amount of spill is increasing the homing probability, either by decreasing the probability of overshoot or increasing the probability of post-overshoot fallback. Including flow and spill as covariates could also be used to shed light on if these are increasing en-route fallback or decreasing the probability of upstream movement.

<br>

This model can also shed light on where new PIT tag antenna installations would be most beneficial, as well as assess how recent PIT tag antenna installations (i.e., in the Lower Granite Dam spillway) are helping with monitoring adult movement. Based on our analysis, tributary arrays in the mainstem Salmon, Clearwater, and Grande Ronde Rivers near the mouth would be very helpful, as this would allow us to estimate detection efficiency in these tributaries and therefore vastly improve our estimates of homing. Furthermore, repairing arrays that have recently been damaged and been decommissioned, most notably the Deschutes River Mouth Array, would also be very useful. The Deschutes River is of particular importance because our analysis indicates that fish of all origins have a relatively high probability of entering this tributary, likely due to its documented use as a cold water refuge [@Hess2016; @Snyder2022]; the median probability for Upper Columbia Steelhead was 0.08, for Snake River Basin Steelhead 0.12, and for Middle Columbia Steelhead ranged from 0.13-0.51 (Appendix 2). Therefore, recommissioning this site would be highly beneficial for monitoring its continued use as a cold-water refuge for PIT-tagged Steelhead and other salmonids.

<br> 

This model could also easily handle other datasets of PIT tag detection histories, such as those from other salmonids in the basin.

# Conclusions

We developed a comprehensive adult migration model for adult Steelhead using 17 years of PIT-tag data from dams and tributaries, and have used the model to estimate probabilities of dam overshoot, fallback, and effects on final homing probabilities. The model will continue to be developed as additional covariates of management interest, such as flow, spill, and rearing practices are integrated into the existing modeling framework, which is highly flexible and can accommodate various covariates. In its present configuration, the model provides insight on the key differences between populations in the Columbia River Basin, such as their final distributions and the effects of movements such as overshoot. This model, with its ability to simultaneously incorporate multiple covariates of interest, will be a valuable asset to managers, allowing us to understand the environmental conditions that contribute to detrimental movement choices and the effectives of available management options for helping Steelhead get home safely.


# References

<div id="refs"></div>



# Appendix 1: Detection probabilities
![Figure 20. Detection probability by tributary and timeframe.](.//figures/DE_plots.pdf){width=100%}


# Appendix 2: Individual movement probabilities

## Middle Columbia River Steelhead
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Upper Columbia

middle_columbia_DPS_probs <- read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "middle_columbia_DE_DPS_probs.csv"), row.names = 1)

# Put an asterisk next to all of these, since they're shared across all origins
# middle_columbia_DPS_probs %>% 
#   mutate(probability= paste0(probability, "*")) -> middle_columbia_DPS_probs

# middle_columbia_DPS_probs %>% 
#   mutate(mean = round(mean, 3),
#          q5 = round(q5, 3),
#          q95 = round(q95, 3)) -> middle_columbia_DPS_probs

middle_columbia_origin_probs <- read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "middle_columbia_DE_origin_probs.csv"), row.names = 1)
middle_columbia_origin_probs %>% 
  # mutate(mean = round(mean, 3),
  #        q5 = round(q5, 3),
  #        q95 = round(q95, 3)) %>% 
  relocate(origin) %>% 
  mutate(origin = gsub("_", " ", origin)) -> middle_columbia_origin_probs

# kable(middle_columbia_DPS_probs, longtable = TRUE, booktabs = T, linesep = "",
#       caption = "Movement probabilities for Upper Columbia Steelhead, outside of the DPS boundaries.") %>%
#   kable_styling(latex_options = c("repeat_header"))
# kable(middle_columbia_origin_probs, booktabs = T, linesep = c("", "", "",  '\\addlinespace'),
#       longtable = TRUE, caption = "Movement probabilities for Upper Columbia Steelhead by natal origin, inside the DPS boundaries.") %>%
#   kable_styling(latex_options = c("repeat_header"))

# testing:
# flextable(middle_columbia_DPS_probs) %>% 
#   align(part = "all") %>% # left align
#   set_caption(caption = "Movement probabilities for Middle Columbia Steelhead, outside of the DPS boundaries.") %>% 
#   font(fontname = "Times New Roman (Body)", part = "all") %>% 
#   fontsize(size = 10, part = "body") %>% 
#   theme_booktabs() %>% # default theme
#   FitFlextableToPage()

# 
# regulartable(middle_columbia_origin_probs)
```


```{r middle_columbia_individual_origins, echo = FALSE, warning = FALSE, message = FALSE}
subset(middle_columbia_origin_probs, origin == "Fifteenmile Creek") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., middle_columbia_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Fifteenmile Creek")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(middle_columbia_origin_probs, origin == "Deschutes River") %>% 
  dplyr::select(-origin) -> deschutes_origin_probs
deschutes_origin_probs %>% 
  bind_rows(., middle_columbia_DPS_probs) -> deschutes_probs

prob_flextable(prob_table = deschutes_probs, trib_name = "Deschutes River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(middle_columbia_origin_probs, origin == "John Day River") %>% 
  dplyr::select(-origin) -> john_day_origin_probs
john_day_origin_probs %>% 
  bind_rows(., middle_columbia_DPS_probs) -> john_day_probs

prob_flextable(prob_table = john_day_probs, trib_name = "John Day River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(middle_columbia_origin_probs, origin == "Umatilla River") %>% 
  dplyr::select(-origin) -> umatilla_origin_probs
umatilla_origin_probs %>% 
  bind_rows(., middle_columbia_DPS_probs) -> umatilla_probs

prob_flextable(prob_table = umatilla_probs, trib_name = "Umatilla River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(middle_columbia_origin_probs, origin == "Walla Walla River") %>% 
  dplyr::select(-origin) -> walla_walla_origin_probs
walla_walla_origin_probs %>% 
  bind_rows(., middle_columbia_DPS_probs) -> walla_walla_probs

prob_flextable(prob_table = walla_walla_probs, trib_name = "Walla Walla River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(middle_columbia_origin_probs, origin == "Yakima River") %>% 
  dplyr::select(-origin) -> yakima_origin_probs
yakima_origin_probs %>% 
  bind_rows(., middle_columbia_DPS_probs) -> yakima_probs

prob_flextable(prob_table = yakima_probs, trib_name = "Yakima River")
```



<br>
<br>  
<br>
  
```{r middle_columbia_table_2, echo = FALSE, message = FALSE, warning = FALSE}
# flextable(middle_columbia_origin_probs) %>% 
#   align(part = "all") %>% # left align
#   set_caption(caption = "Movement probabilities for Upper Columbia Steelhead by natal origin, inside the DPS boundaries.") %>% 
#   font(fontname = "Times New Roman (Body)", part = "all") %>% 
#   fontsize(size = 10, part = "body") %>% 
#   theme_booktabs() %>% # default theme
#   FitFlextableToPage()
```

## Upper Columbia River Steelhead
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Upper Columbia

upper_columbia_DPS_probs <- read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "upper_columbia_DE_DPS_probs.csv"), row.names = 1)

# Put an asterisk next to all of these, since they're shared across all origins
# upper_columbia_DPS_probs %>% 
#   mutate(probability= paste0(probability, "*")) -> upper_columbia_DPS_probs
# upper_columbia_DPS_probs %>% 
#   mutate(mean = round(mean, 3),
#          q5 = round(q5, 3),
#          q95 = round(q95, 3)) -> upper_columbia_DPS_probs

upper_columbia_origin_probs <- read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "upper_columbia_DE_origin_probs.csv"), row.names = 1)
upper_columbia_origin_probs %>% 
  # mutate(mean = round(mean, 3),
  #        q5 = round(q5, 3),
  #        q95 = round(q95, 3)) %>% 
  relocate(origin) %>%
  mutate(origin = gsub("_", " ", origin)) -> upper_columbia_origin_probs

# kable(upper_columbia_DPS_probs, longtable = TRUE, booktabs = T, linesep = "",
#       caption = "Movement probabilities for Upper Columbia Steelhead, outside of the DPS boundaries.") %>%
#   kable_styling(latex_options = c("repeat_header"))
# kable(upper_columbia_origin_probs, booktabs = T, linesep = c("", "", "",  '\\addlinespace'),
#       longtable = TRUE, caption = "Movement probabilities for Upper Columbia Steelhead by natal origin, inside the DPS boundaries.") %>%
#   kable_styling(latex_options = c("repeat_header"))

# testing:
# flextable(upper_columbia_DPS_probs) %>% 
#   align(part = "all") %>% # left align
#   set_caption(caption = "Movement probabilities for Upper Columbia Steelhead, outside of the DPS boundaries.") %>% 
#   font(fontname = "Times New Roman (Body)", part = "all") %>% 
#   fontsize(size = 10, part = "body") %>% 
#   theme_booktabs() %>% # default theme
#   FitFlextableToPage()

# 
# regulartable(upper_columbia_origin_probs)
```


```{r upper_columbia_individual_origins, echo = FALSE, warning = FALSE, message = FALSE}
subset(upper_columbia_origin_probs, origin == "Wenatchee River") %>% 
  dplyr::select(-origin) -> wenatchee_origin_probs
wenatchee_origin_probs %>% 
  bind_rows(., upper_columbia_DPS_probs) -> wenatchee_probs

prob_flextable(prob_table = wenatchee_probs, trib_name = "Wenatchee River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}

subset(upper_columbia_origin_probs, origin == "Entiat River") %>% 
  dplyr::select(-origin) -> entiat_origin_probs
entiat_origin_probs %>% 
  bind_rows(., upper_columbia_DPS_probs) -> entiat_probs

prob_flextable(prob_table = entiat_probs, trib_name = "Entiat River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(upper_columbia_origin_probs, origin == "Methow River") %>% 
  dplyr::select(-origin) -> methow_origin_probs
methow_origin_probs %>% 
  bind_rows(., upper_columbia_DPS_probs) -> methow_probs

prob_flextable(prob_table = methow_probs, trib_name = "Methow River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(upper_columbia_origin_probs, origin == "Okanogan River") %>% 
  dplyr::select(-origin) -> okanogan_origin_probs
okanogan_origin_probs %>% 
  bind_rows(., upper_columbia_DPS_probs) -> okanogan_probs

prob_flextable(prob_table = okanogan_probs, trib_name = "Okanogan River")
```

<br>
<br>
<br>

```{r upper_columbia_table_2, echo = FALSE, message = FALSE, warning = FALSE}
# flextable(upper_columbia_origin_probs) %>% 
#   align(part = "all") %>% # left align
#   set_caption(caption = "Movement probabilities for Upper Columbia Steelhead by natal origin, inside the DPS boundaries.") %>% 
#   font(fontname = "Times New Roman (Body)", part = "all") %>% 
#   fontsize(size = 10, part = "body") %>% 
#   theme_booktabs() %>% # default theme
#   FitFlextableToPage()
```

## Snake River Basin Steelhead
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Snake River

snake_DPS_probs <- read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "snake_DE_DPS_probs.csv"), row.names = 1)

# Put an asterisk next to all of these, since they're shared across all origins
# snake_DPS_probs %>% 
#   mutate(probability= paste0(probability, "*")) -> snake_DPS_probs

# snake_DPS_probs %>% 
#   mutate(mean = round(mean, 3),
#          q5 = round(q5, 3),
#          q95 = round(q95, 3)) -> snake_DPS_probs

snake_origin_probs <- read.csv(here::here("stan_actual", "deteff_ESU_models", "output_tables", "snake_DE_origin_probs.csv"), row.names = 1)
snake_origin_probs %>% 
  # mutate(mean = round(mean, 3),
  #        q5 = round(q5, 3),
  #        q95 = round(q95, 3)) %>% 
  relocate(origin) %>% 
  mutate(origin = gsub("_", " ", origin)) -> snake_origin_probs

# kable(snake_DPS_probs, longtable = TRUE, booktabs = T, linesep = "",
#       caption = "Movement probabilities for Upper Columbia Steelhead, outside of the DPS boundaries.") %>%
#   kable_styling(latex_options = c("repeat_header"))
# kable(snake_origin_probs, booktabs = T, linesep = c("", "", "",  '\\addlinespace'),
#       longtable = TRUE, caption = "Movement probabilities for Upper Columbia Steelhead by natal origin, inside the DPS boundaries.") %>%
#   kable_styling(latex_options = c("repeat_header"))

# testing:
# flextable(snake_DPS_probs) %>% 
#   align(part = "all") %>% # left align
#   set_caption(caption = "Movement probabilities for Upper Columbia Steelhead, outside of the DPS boundaries.") %>% 
#   font(fontname = "Times New Roman (Body)", part = "all") %>% 
#   fontsize(size = 10, part = "body") %>% 
#   theme_booktabs() %>% # default theme
#   FitFlextableToPage()

# 
# regulartable(snake_origin_probs)
```

```{r snake_individual_origins, echo = FALSE, warning = FALSE, message = FALSE}
subset(snake_origin_probs, origin == "Tucannon River") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., snake_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Tucannon River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(snake_origin_probs, origin == "Clearwater River") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., snake_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Clearwater River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(snake_origin_probs, origin == "Asotin Creek") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., snake_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Asotin Creek")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(snake_origin_probs, origin == "Grande Ronde River") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., snake_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Grande Ronde River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(snake_origin_probs, origin == "Salmon River") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., snake_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Salmon River")
```
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
subset(snake_origin_probs, origin == "Imnaha River") %>% 
  dplyr::select(-origin) -> fifteenmile_origin_probs
fifteenmile_origin_probs %>% 
  bind_rows(., snake_DPS_probs) -> fifteenmile_probs

prob_flextable(prob_table = fifteenmile_probs, trib_name = "Imnaha River")


```

<br>
  <br>
  <br>
  
```{r snake_table_2, echo = FALSE, message = FALSE, warning = FALSE}
# flextable(snake_origin_probs) %>% 
#   align(part = "all") %>% # left align
#   set_caption(caption = "Movement probabilities for Upper Columbia Steelhead by natal origin, inside the DPS boundaries.") %>% 
#   font(fontname = "Times New Roman (Body)", part = "all") %>% 
#   fontsize(size = 10, part = "body") %>% 
#   theme_booktabs() %>% # default theme
#   FitFlextableToPage()
```


\setlength{\parindent}{-0.375in}
\setlength{\leftskip}{0.375in}
\setlength{\parskip}{8pt}
\noindent