---
title: "01_data_querying"
author: "Markus Min"
date: "1/14/2022"
output: html_document
---

### Description
This Rmd file will go through querying PTAGIS and cleaning this data in order to prepare it for analysis.

# Determine datasets to query
To determine which datasets (natal origins) to include in our analysis, we are going to begin by examining all adult returns (detections in the adult fishway at BON) since 2005.

This first query will take the following attributes:

Advanced Reporting Home Page > Create Query Builder2 Report > Interrogation Summary

Once in Query Builder2, select the following filters:
- 1 Attributes: Standard + Release Site Basin, Release Site Subbasin, mark site basin, mark site subbasin, release site longitude, release site latitude, mark site
- 2 Metrics: Count, First Obs Date Max, Hatchery
- 16 First Obs Date/Time: 
  - From: Value 
  - Is: Greater than or equal to
    - Value: 6/1/2005 12:00:00 AM
- 18 Obs Site: BO1 - Bonneville Bradford Is. Ladder, BO2 - Bonneville Cascades Is. Ladder, BO3 - Bonneville WA Shore Ladder/AFF, BO4 - Bonneville WA Ladder Slots, B2A - BONNEVILLE ADULT WA SHORE, BWL - Bonneville WA Shore Ladder
  - These are all of the Bonneville adult fishways and there::herefore will allow you to identify all adult returns
- 25 Species: Steelhead
- 29 Mark Length: Less than or equal to 350 (to ensure you are only keeping individuals tagged as Juveniles)

Run Report, and download as a CSV. Save this in PTAGIS_queries > intermediate_files

## Inspect distribution of natal origins and run years
```{r load_libraries}
library(tidyverse)
library(here)
library(janitor)
library(lubridate)
```

```{r import_reformat_data}
adult_returns <- clean_names(read.csv(here::here("PTAGIS_queries", "intermediate_files", "all_adult_returns.csv")))

# Keep only certain columns
adult_returns %>% 
  distinct(tag_code, .keep_all = TRUE) %>% 
  dplyr::select(tag_code, first_time_value, rear_type_code, release_site_name, release_site_basin_name, release_site_subbasin_name,
                mark_site_basin_name, mark_site_subbasin_name, mark_site_name) %>% 
  mutate(time = mdy_hms(first_time_value)) %>% 
  mutate(date = date(time)) %>% 
  dplyr::select(-c(first_time_value, time))-> adult_returns

# Sort into run years
run_year <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21", "21/22")
run_year_start <- seq(ymd("2005-06-01"), ymd("2021-06-01"), by = "years")
run_year_end <- seq(ymd("2006-05-31"), ymd("2022-05-31"), by = "years")

run_year_df <- data.frame(run_year, run_year_start, run_year_end)

adult_returns %>% 
  mutate(dummy =TRUE) %>% 
  left_join(run_year_df %>% mutate(dummy=TRUE), by = "dummy") %>% 
  filter(run_year_start <= date, run_year_end >= date) %>% 
  select(-c(dummy, run_year_start, run_year_end)) -> adult_returns


```

### Inspect distributions by run years and origins
Compare to Shelby's data - subset 05/06 to 14/15
```{r}
adult_returns %>% 
  subset(!(run_year %in% c("15/16", "16/17", "17/18", "18/19", "19/20", "20/21", "21/22"))) -> adult_returns_subset

# basin name is not specific enough
basin_table <- as.data.frame(table(adult_returns_subset$release_site_basin_name))
subbasin_table <- as.data.frame(table(adult_returns_subset$release_site_subbasin_name))
subbasin_table %>% 
  dplyr::rename(subbasin = Var1, count = Freq) %>% 
  arrange(desc(count)) -> subbasin_table

basin_table %>% 
  dplyr::rename(subbasin = Var1, count = Freq) %>% 
  arrange(desc(count)) -> basin_table

subset(adult_returns, release_site_subbasin_name == "Lower Snake-Tucannon")

table(subset(adult_returns, release_site_subbasin_name == "Lower Snake-Tucannon")$release_site_name)

subbasin_table
basin_table

# Get name of all unique release sites
release_sites <- unique(adult_returns$release_site_name)
# Get names of all unique mark sites
mark_sites <- unique(adult_returns$mark_site_name)
```

### Hood River
```{r}
# Hood River
subset(adult_returns_subset, release_site_subbasin_name == "Middle Columbia-Hood")

# This includes a lot of fish from the Wind River, which is not part of the Hood River system

# look at a table of release site names
as.data.frame(table(subset(adult_returns_subset, release_site_subbasin_name == "Middle Columbia-Hood")$release_site_name))
# compare to mark sites
as.data.frame(table(subset(adult_returns_subset, mark_site_subbasin_name == "Middle Columbia-Hood")$mark_site_name))

# what are the fish that were released between Bonneville and John Day?
subset(adult_returns_subset, release_site_name == "COLR4 - Columbia River - Bonneville Dam to John Day Dam (km 234-347)")
# Lots were marked at the John Day dam, but unclear where they are from


### Inspect release sites

# Have to add Parkdale Hatchery, which is on the middle fork of the Hood River
hood_sites <- c(release_sites[grep("Hood", release_sites)], "PARK - Parkdale Hatchery")
# Tons of these fish came from the Oak Springs Hatchery on the Deschutes

hood_fish <-  subset(adult_returns_subset, release_site_name %in% hood_sites)
table(hood_fish$run_year)
table(hood_fish$rear_type_code)
# way short on fish - should have over 2000, not 1340
# it looks like we have all but 2 wild fish, but are missing 800 hatchery fish. Were they released somewhere else? Should we be looking at the mark site, not release site

# could the wind river and white salmon river account for these differences?
hood_sites <- c(release_sites[grep("Hood", release_sites)], "PARK - Parkdale Hatchery", "TROUTC - Trout Creek (trib. to Wind River, Wash.)", "WIND2R - Wind River, Washington")

hood_fish <-  subset(adult_returns_subset, release_site_name %in% hood_sites)
table(hood_fish$rear_type_code)
# doesn't seem like it - it looks like a lot of missing hatchery fish

### Inspect mark sites
hood_mark_sites <- c(mark_sites[grep("Hood", mark_sites)], "PARK - Parkdale Hatchery")
hood_fish <-  subset(adult_returns_subset, mark_site_name %in% hood_mark_sites)

```

### Fifteenmile Creek
343 vs 352
- pretty close!
```{r}
fifteenmile_sites <- release_sites[grep("Fifteen", release_sites)]

fifteenmile_fish <-  subset(adult_returns_subset, release_site_name %in% fifteenmile_sites)
table(fifteenmile_fish$run_year)
# these numbers are close, but just a bit off - even to the point where we have one fish too many in 09/10
subset(fifteenmile_fish, run_year == "09/10")
```

### Deschutes River
Shelby: 807 wild
Me: 804 wild
- pretty close, maybe some of these are iteroparous individuals that go into multiple run years
```{r}
deschutes_sites <- release_sites[grep("Deschutes", release_sites)]

deschutes_fish <-  subset(adult_returns_subset, release_site_name %in% deschutes_sites)
# 776 wild

# What about mark site basin
deschutes_fish <-  subset(adult_returns_subset, mark_site_basin_name == "Deschutes")
# Tons of hatchery fish that weren't released in the Deschutes

# What if we take only those wild fish
deschutes_fish <-  subset(adult_returns_subset, mark_site_basin_name == "Deschutes" & rear_type_code == "W")
# 804 wild

# what about by release basin? Since Deschutes is a basin
deschutes_fish <-  subset(adult_returns_subset, release_site_basin_name == "Deschutes")
# 804 wild

```

### John Day River
2119 wild fish vs 2121 fish from Shelby
I also had 2121 fish in my analysis - where did those fish go?
```{r}
jdr_fish <- subset(adult_returns_subset, release_site_subbasin_name %in% c("Upper John Day", "North Fork John Day", "Middle Fork John Day", "Lower John Day"))

JDR_CTH_1 <- clean_names(read.csv(here::here("PTAGIS_queries", "complete_tag_histories", "john_day_river", "2022-01-14-john_day_river_CTH_2005_2015_1.csv")))
JDR_CTH_2 <- clean_names(read.csv(here::here("PTAGIS_queries", "complete_tag_histories", "john_day_river", "2022-01-14-john_day_river_CTH_2005_2015_2.csv")))

### Combine files, fix some column data types
JDR_CTH_1 %>% 
  bind_rows(., JDR_CTH_2) %>% 
  mutate(event_date_time_value = mdy_hms(event_date_time_value))-> JDR_CTH


setdiff(unique(JDR_CTH$tag_code), jdr_fish$tag_code)

subset(JDR_CTH, tag_code %in% c("3D9.1C2D814B91", "3D9.1C2D84C4F9"))

subset(adult_returns_subset, tag_code %in% c("3D9.1C2D814B91", "3D9.1C2D84C4F9"))

# Release site name is "- Unknown"? What the heck? But we would find these if used mark site... but we also known that that's not super reliable.
```

### Umatilla River
Shelby: 496 hatchery, 470 wild
Me: 430 hatchery, 462 wild
```{r}
# by release site name
umatilla_sites <- release_sites[grep("Umatilla", release_sites)]

umatilla_fish <-  subset(adult_returns_subset, release_site_name %in% umatilla_sites)

# by release site subbasin
umatilla_fish <- subset(adult_returns_subset, release_site_subbasin_name =="Umatilla")
table(umatilla_fish$rear_type_code)
table(subset(umatilla_fish, rear_type_code == "W")$run_year)
table(subset(umatilla_fish, rear_type_code == "H")$run_year)
# missing a bunch of hatchery fish especially in the last few run years (13/14 and 14/15 especially)

```

### Walla Walla River
Shelby: 1,692 hatchery, 535 wild
```{r}
# by release site name
wallawalla_sites <- release_sites[grep("Walla Walla", release_sites)]

wallawalla_fish <-  subset(adult_returns_subset, release_site_name %in% wallawalla_sites)
# Way short

# by release site subbasin
wallawalla_fish <- subset(adult_returns_subset, release_site_subbasin_name =="Walla Walla")
table(wallawalla_fish$release_site_name)
table(wallawalla_fish$rear_type_code)
# 94 hatchery (way short), 531 wild (pretty close!)

# what about by mark site
wallawalla_fish <- subset(adult_returns_subset, mark_site_subbasin_name =="Walla Walla")
table(wallawalla_fish$rear_type_code)
# even worse!

```


### Yakima River
Shelby: 302 wild
Me: 301 wild
```{r}
# by release site name
yakima_sites <- release_sites[grep("Yakima", release_sites)]

yakima_fish <-  subset(adult_returns_subset, release_site_name %in% yakima_sites)


# By release site basin
yakima_fish <- subset(adult_returns_subset, release_site_basin_name =="Yakima")
```


### Wenatchee River
Shelby: 4,147 hatchery, 310 wild
Me: 2986 hatchery,  307 wild
```{r}
# by release site name
wenatchee_sites <- release_sites[grep("Wenatchee", release_sites)]

wenatchee_fish <-  subset(adult_returns_subset, release_site_name %in% wenatchee_sites)


# By release site subbasin
wenatchee_fish <- subset(adult_returns_subset, release_site_subbasin_name =="Wenatchee")
table(wenatchee_fish$rear_type_code)
# Missing >1000 hatchery fish, only 3 wild
```


### Entiat River
Shelby: 360 wild
Me: 357 wild
```{r}
# by release site name
entiat_sites <- release_sites[grep("Entiat", release_sites)]

# By release site subbasin
entiat_fish <- subset(adult_returns_subset, release_site_subbasin_name =="Upper Columbia-Entiat")
table(entiat_fish$rear_type_code)
# way too many fish, including some hatchery fish
# Most are hatchery releases at RRE and RIS, some wild releases at RRE and RIS as well

entiat_fish <-  subset(adult_returns_subset, release_site_name %in% entiat_sites)
# 357 wild fish - quite close
```


### Tucannon River
Shelby: 2,533 hatchery, 419 wild
Me: 380 hatchery, 414 wild
```{r}
# by release site name
tucannon_sites <- release_sites[grep("Tucannon", release_sites)]

# By release site subbasin
tucannon_fish <- subset(adult_returns_subset, release_site_subbasin_name == "Lower Snake-Tucannon")
table(tucannon_fish$rear_type_code)
# WAY too many fish - subbasin is not fine enough resolution

# what about mark site
tucannon_fish <- subset(adult_returns_subset, mark_site_subbasin_name == "Lower Snake-Tucannon")
unique(tucannon_fish$mark_site_name)
# Okay, so this include TUCH - Tucannon River Hatchery
subset(adult_returns_subset, mark_site_name == "TUCH - Tucannon River Hatchery")
# only 138 - already accounted for in TUCR release site

# Look at the other mark sites
table(subset(adult_returns_subset, mark_site_subbasin_name == "Lower Snake-Tucannon")$mark_site_name)
# Vast majority seem to be released at Lower Granite - some of these are Tucannon? But how to know which ones?
subset(adult_returns_subset, mark_site_name == "LGR - Lower Granite Dam")

# Look at the individual sites
unique(subset(adult_returns_subset, release_site_subbasin_name == "Lower Snake-Tucannon")$release_site_name)
sort(release_sites)



tucannon_fish <-  subset(adult_returns_subset, release_site_name %in% tucannon_sites)
table(tucannon_fish$rear_type_code)
# 380 hatchery, 414 wild. Wild are quite close, hatchery not so much
```

### Clearwater River
Shelby: 3,175 hatchery, 1,163 wild
Me : 373 hatchery, 1158 wild
```{r}
# by release site name
clearwater_sites <- release_sites[grep("Clearwater", release_sites)]

clearwater_fish <-  subset(adult_returns_subset, release_site_name %in% clearwater_sites)
table(clearwater_fish$rear_type_code)
# Way short on all fish

# By release site basin
clearwater_fish <- subset(adult_returns_subset, release_site_basin_name == "Clearwater")
table(clearwater_fish$rear_type_code)
# 1,158 wild fish - very close. But only 373 hatchery fish, not even close

table(adult_returns_subset$release_site_basin_name)
```

### Grande Ronde River
Shelby: 4,239 hatchery, 549 wild
Me: 850 hatchery (way short), 545 wild (very close)
```{r}
# by release site name
granderonde_sites <- release_sites[grep("Grande Ronde", release_sites)]

granderonde_fish <-  subset(adult_returns_subset, release_site_name %in% granderonde_sites)
table(granderonde_fish$rear_type_code)
# Way short on all fish

# By release site basin
granderonde_fish <- subset(adult_returns_subset, release_site_subbasin_name %in% c("Lower Grande Ronde", "Upper Grande Ronde", "Wallowa"))
table(granderonde_fish$rear_type_code)
# 850 hatchery (way short), 545 wild (very close)

table(adult_returns_subset$release_site_subbasin_name)
table(subset(adult_returns_subset, release_site_basin_name == "Lower Snake")$release_site_subbasin_name)
```

### Salmon River
Shelby: 7,661 hatchery, 831 wild
Me: 226 hatchery, 827 wild
```{r}
# by release site name
salmon_sites <- release_sites[grep("Salmon", release_sites)]

salmon_fish <-  subset(adult_returns_subset, release_site_name %in% salmon_sites)
table(salmon_fish$rear_type_code)
# Way short on all fish

# By release site basin
salmon_fish <- subset(adult_returns_subset, release_site_basin_name == "Salmon")
table(salmon_fish$rear_type_code)
# 226 hatchery (way short), 827 wild (very close)

table(adult_returns_subset$release_site_subbasin_name)
table(adult_returns_subset$release_site_basin_name)
table(subset(adult_returns_subset, release_site_basin_name == "Lower Snake")$release_site_subbasin_name)
```

### Imnaha River
Shelby: 2,613 hatchery, 925 wild
Me: 379 hatchery, 918 wild
```{r}
# by release site name
imnaha_sites <- release_sites[grep("Imnaha", release_sites)]

imnaha_fish <-  subset(adult_returns_subset, release_site_name %in% imnaha_sites)
table(imnaha_fish$rear_type_code)
# 116 hatchery (way short), 918 wild (close)

# By release site subbasin
imnaha_fish <- subset(adult_returns_subset, release_site_subbasin_name == "Imnaha")
table(imnaha_fish$rear_type_code)
# 379 hatchery (way short), 918 wild (very close)

table(adult_returns_subset$release_site_subbasin_name)
table(adult_returns_subset$release_site_basin_name)
table(subset(adult_returns_subset, release_site_basin_name == "Lower Snake")$release_site_subbasin_name)
```



# PTAGIS workflow
PTAGIS querying has been set up to work in two steps:


### Step 1 (in PTAGIS): Determine the tag codes of adult returns to Bonneville
On the PTAGIS website once you have logged in, navigate to Advanced Reporting Home Page > Create Query Builder2 Report > Interrogation Summary

Once in Query Builder2, select the following filters:
- 1 Attributes: Standard
- 2 Metrics: Count, First Obs Date Max
- 9 Mark Site Subbasin == Your river of interest
  - Example: If you were querying data for the John Day River, you could search for "John Day" and then select the subbasins. In this case, you would select Upper John Day, North Fork John Day, Middle Fork John Day, and Lower John Day.
- 16 First Obs Date/Time: 
  - From: Value 
  - Is: Between
  - Value: The first date in your query
  - And: The last date in your query
  - For example, if you wanted all fish from run years 05/06 to 14/15, using June 1 as the separating date, you would have:
    - Value: 6/1/2005 12:00:00 AM
    - And: 5/31/2015 11:59:59 PM
- 18 Obs Site: BO1 - Bonneville Bradford Is. Ladder, BO2 - Bonneville Cascades Is. Ladder, BO3 - Bonneville WA Shore Ladder/AFF, BO4 - Bonneville WA Ladder Slots, B2A - BONNEVILLE ADULT WA SHORE, BWL - Bonneville WA Shore Ladder
  - These are all of the Bonneville adult fishways and there::herefore will allow you to identify all adult returns
- 25 Species: Steelhead
- 29 Mark Length: Less than or equal to 350 (to ensure you are only keeping individuals tagged as Juveniles)

Run Report, and download as a CSV. Save this in PTAGIS_queries > intermediate_files

NOTE

### Step 2 (in R): Get the tag codes of the adult returns

We will write a function to extract all of the unique tags for adult returns and export this as a text file that you can then use to query PTAGIS to get complete tag histories.

Note: PTAGIS seems to struggle with queries of over 2,000 tag codes (even though it says it can take up to 15,000). This code breaks up your tag files into chunks of 2,000 in the case of large queries, so you will have to concatenate them later.

```{r identify_adult_return_tags}
# NOTE: DO NOT INCLUDE ".csv" and ".txt" in input_CSV or output_txt

ID_adult_returns <- function(input_CSV, output_txt, river_system){
  # Load the libraries
  library(tidyverse)
  library(here)
  library(janitor)
  
  BON_adult_returns <- clean_names(read.csv(here::here("PTAGIS_queries", "intermediate_files", river_system,  paste0(input_CSV, ".csv"))))
  
  as.data.frame(unique(BON_adult_returns$tag_code)) -> unique_tags
  
  if (length(unique_tags > 2000)){
    ntags <- length(unique_tags[,1])
    nfiles <- ceiling(ntags/2000)
    
    # Make an empty list to store the different files
    file_list <- list()
    
    # Split the tags into multiple files
    for (i in 1:nfiles){
      file_list[[i]] <- unique_tags[(1 + 2000 * (i - 1)):(2000 * i),1][!(is.na(unique_tags[(1 + 2000 * (i - 1)):(2000 * i),1]))]
    }
    
    # export the files
    for (i in 1:nfiles){
      write.table(file_list[[i]], file = here::here("PTAGIS_queries", "intermediate_files", river_system, paste0(output_txt, "_", i, ".txt")), col.names = FALSE, row.names = FALSE, quote = FALSE) 
    }
  }
  
  else {
   write.table(unique_tags, file = here::here("PTAGIS_queries", "intermediate_files", river_system, output_txt), col.names = FALSE, row.names = FALSE, quote = FALSE) 
  }
}
```


### Step 3 (in PTAGIS): Get complete tag histories for adult returns
- On the PTAGIS website once you have logged in, navigate to Advanced Reporting Home Page > Home > Create Query Builder2 Report > Complete Tag History

Query Builder2:
- 1 Attributes: Tag, Event Type, Event Site, Event Date, Event Release Site, Event Release Date, (these first six are all standard, the rest you have to add manually) Event Date Time, Event Site Basin, Event Site Info, Event Site Code, Event Site Subbasin, Event Site Latitude, Event Site Longitude
- 2 Metrics: Standard
- 29 Tag Code: Import text file(s) that you exported from R
  - NOTE: You may have to run multiple queries if you have more than 2,000 tag codes

# Individual Queries


## John Day River, Wild Steelhead


### Query 1 - adult returns to BON
Interrogation Summary

Query Builder2 filters:
- 1 Attributes: Standard
- 2 Metrics: Count, First Obs Date Max
- 9 Mark Site Subbasin == Upper John Day, North Fork John Day, Middle Fork John Day, and Lower John Day.
- 16 First Obs Date/Time: 
  - From: Value 
  - Is: Between
    - Value: 6/1/2005 12:00:00 AM
    - And: 5/31/2015 11:59:59 PM
- 18 Obs Site: BO1 - Bonneville Bradford Is. Ladder, BO2 - Bonneville Cascades Is. Ladder, BO3 - Bonneville WA Shore Ladder/AFF, BO4 - Bonneville WA Ladder Slots, B2A - BONNEVILLE ADULT WA SHORE, BWL - Bonneville WA Shore Ladder
- 25 Species: Steelhead
- 29 Mark Length: Less than or equal to 350

Export CSV file: 2022-01-14-john_day_river_bon_adult_returns_2005-2015.csv

#### Get adult tag IDs
```{r}
ID_adult_returns(input_CSV = "2022-01-14-john_day_river_bon_adult_returns_2005-2015", output_txt = "2022-01-14-john_day_river_bon_adult_returns_2005-2015_TAGS",
                 river_system = "john_day_river")
```

### Query 2 - complete tag histories
Complete Tag History

Query Builder2:
- 1 Attributes: Tag, Event Type, Event Site, Event Date, Event Release Site, Event Release Date, (these first six are all standard, the rest you have to add manually) Event Date Time, Event Site Basin, Event Site Info, Event Site Code, Event Site Subbasin
- 2 Metrics: Standard
- 29 Tag Code: Import text file that you exported from R
  - 2 files: 2022-01-14-john_day_river_bon_adult_returns_2005-2015_TAGS_1.txt AND 2022-01-14-john_day_river_bon_adult_returns_2005-2015_TAGS_1.txt
    - These are separate queries

Export CSV files, save in PTAGIS_queries -> complete_tag_histories-> john_day_river :
2022-01-14-john_day_river_CTH_2005_2015_1.csv
2022-01-14-john_day_river_CTH_2005_2015_2.csv



# Covariate queries
In addition to the PIT tag detection histories for fish, we also need to query the covariate data from CBR DART.

What Shelby did:

"Water temperature, flow, and spill data were downloaded on 5 January, 2017. Daily water temperatures in the forebay outflow of McNary, Ice Harbor, Lower Granite, Priest Rapids, Rocky Reach, and Wells dams from 2005 to 2015 were downloaded from Columbia River DART (www.cbr.washington.edu/dart). Records of spill and outflow during the months of January, February, and March were also downloaded from Columbia River DART for the same dams. Stream temperature data for each tributary were queried from the U.S. Geological Survey, U.S. Department of the Interior Bureau of Reclamation, and Washington Department of Ecology. Natal stream temperature data were obtained for the mainstem Umatilla, Walla Walla, and Tucannon rivers. Multiple years of stream temperature data from a mainstem site within 75 rkm of the river mouth were not available for the remaining four tributaries. Umatilla data were obtained from the U.S. Department of the Interior Bureau of Reclamation (https://www.usbr.gov). "

To navigate to the appropriate page on CBR DART:

Homepage > Basin conditions > Project all years

We then need to query each dam separately.

1. Select the dam
2. Select the data
  - Here, we would be interested in "Outflow KCFS, Daily Average", "Spill KCFS, Daily Average", "Temperature C, Daily Average", and maybe "Temperature C, Tailrace, Daily Average"
    - Need to clarify some of the differences

Dams: 
- BON-Bonneville
- DWR-Dworshak
- IHR-Ice Harbor
- JDA-John Day
- LGS-Little Goose
- LWG-Lower Granite
- LMN-Lower Monumental
- MCN-McNary
- PRD-Priest Rapids
- RIS-Rock Island
- RRH-Rocky Reach
- TDA-The Dalles
- WAN-Wanapum
- WEL-Wells


