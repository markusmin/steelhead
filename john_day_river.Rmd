---
title: "John_Day_River"
author: "Markus Min"
date: "1/5/2022"
output: html_document
---

In this Rmd we will be recreating Shelby Richins' results for John Day River Steelhead.

NOTE: PIT tag detectors were only installed in the two adult fish ladders at John Day Dam in 2017. So from 2005-2015 we last see them at the Dalles Dam, and then in the John Day River


# PTAGIS Query

## Query 1 - adult returns to BON
- Interrogation Detail

Query Builder2:
- 1 Attributes: Standard
- 2 Metrics: Obs Count, Obs Time Max, Obs Time Min
- 9 Mark Site Subbasin == Upper John Day, North Fork John Day, Middle Fork John Day, Lower John Day
  - Searched "John Day" and selected all
- 16 Obs Time: Value between 6/1/2005 12:00:00 AM and 5/31/2015 11:59:59
- 17 Obs Site: BO1 - Bonneville Bradford Is. Ladder, BO2 - Bonneville Cascades Is. Ladder, BO3 - Bonneville WA Shore Ladder/AFF, BO4 - Bonneville WA Ladder Slots
- 24 Species: Steelhead
- 29 Mark Length: Less than or equal to 350


### Examine data

#### Load libraries
```{r load_libraries}
library(tidyverse)
library(here)
library(janitor)
library(lubridate)
```

#### Import data
```{r load_data}
JDR_BON_adult_returns <- clean_names(read.csv(here("PTAGIS_queries", "intermediate_files",  "2022-01-06-john_day_river_bon_adult_returns_2005-2015.csv")))
```

#### Inspect data
```{r}
# Unique tags?
length(unique(JDR_BON_adult_returns$tag_code))
# 2,121 unique tags - and they're all wild (or unknown)! This matches Shelby's numbers for wild fish.

# Count by year
# Reformat dates
JDR_BON_adult_returns %>% 
  mutate(obs_time_value = mdy_hms(obs_time_value)) %>% 
  mutate(year = year(obs_time_value)) -> JDR_BON_adult_returns
```

#### Export tags for querying PTAGIS
```{r}
as.data.frame(unique(JDR_BON_adult_returns$tag_code)) -> JDR_unique_tags

write.table(JDR_unique_tags, file = here(here("PTAGIS_queries", "intermediate_files",  "2022-01-06-john_day_river_bon_adult_returns_2005-2015_TAGS.txt")), col.names = FALSE, row.names = FALSE, quote = FALSE)
```

## QUERY 2
- Complete tag history

Query Builder2:
- 1 Attributes: Standard
- 2 Metrics: Standard
- 29 Tag Code: 2022-01-06-john_day_river_bon_adult_returns_2005-2015_TAGS.txt

# Analysis

## Import and clean data
```{r}
JDR_CTH <- clean_names(read.csv(here("PTAGIS_queries", "complete_tag_histories", "2022-01-06-jdr_2005_2015_complete_tag_history.csv")))
JDR_CTH %>% 
  mutate(event_date = mdy(event_date_mmddyyyy)) %>% 
  arrange(tag_code, event_date) %>% 
  dplyr::select(tag_code, event_type_name, event_site_name, cth_count, event_date) -> JDR_CTH

JDR_CTH
```


Determine run timing based on the date/time of first observation at:
- Bonneville Dam
- overshoot dams (first dam with PIT detection capabilities upstream of the natal tributary)
  - Look in adult latter, or time of first observation above overshoot dam
- in natal tributary

Sort into run years by June 1




# Project Branch




