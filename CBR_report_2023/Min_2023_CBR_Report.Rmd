---
title: "Columbia Basin Research"
subtitle: "2023 Progress Report: A Bayesian multidirectional, multistate model to resolve the migration pathways of adult Steelhead within the Columbia River Basin"
author: "Markus Min"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document:
    reference_docx: CBR_template.docx
  pdf_document: default
documentclass: report
toc: TRUE
toc-depth: 2
geometry: margin=1in
linestretch: 1.1
fontsize: 12pt
header-includes:
  - \usepackage{lineno}
  - \usepackage{amsmath}
  - \usepackage{mathtools}
  - \linenumbers
urlcolor: blue
bibliography: Steelhead.bib
csl: jpe.csl
always_allow_html: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">"
)

options(scipen=999)
```

```{r load_functions_libraries, echo = FALSE, warning = FALSE, message = FALSE}
library(here)
library(kableExtra)
library(tidyverse)
library(flextable)
library(officer)
library(janitor)

# Make a function to actually fit the flextable
FitFlextableToPage <- function(ft, pgwidth = 8){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

# Get the tributary order for plotting, to keep it consistent throughout the tables
natal_origin_order <- c("Hood_River", "Fifteenmile_Creek", "Deschutes_River",  "John_Day_River",  "Umatilla_River", "Walla_Walla_River",
                        "Yakima_River", "Wenatchee_River", "Entiat_River", "Methow_River", "Okanogan_River",                
                        "Tucannon_River", "Clearwater_River", "Asotin_Creek", "Grande_Ronde_River", "Salmon_River", "Imnaha_River")

middle_columbia_origins <- c("Fifteenmile Creek", "Deschutes River", "John Day River", "Umatilla River", "Walla Walla River", "Yakima River")
upper_columbia_origins <- c("Wenatchee River", "Entiat River",    "Okanogan River",  "Methow River")
snake_origins <- c("Tucannon River",   "Asotin Creek", "Clearwater River", "Salmon River",  "Grande Ronde River", "Imnaha River")

# ORDER THE STATES
model_states = c(
  # Mainstem states (9)
  "mainstem, mouth to BON",
  "mainstem, BON to MCN",
  "mainstem, MCN to ICH or PRA",
  "mainstem, PRA to RIS",
  "mainstem, RIS to RRE",
  "mainstem, RRE to WEL",
  "mainstem, upstream of WEL",
  "mainstem, ICH to LGR",
  "mainstem, upstream of LGR",
  
  # Tributary states ()
  # With detection efficiencies in the model, we now have more tributary states,
  # since we have an upstream and a river mouth state
  
  # "Deschutes River", 
  "Deschutes River Mouth", "Deschutes River Upstream",
  # "John Day River", 
  "John Day River Mouth", "John Day River Upstream",
  # "Hood River",
  "Hood River Mouth", "Hood River Upstream",
  # "Fifteenmile Creek", 
  "Fifteenmile Creek Mouth", "Fifteenmile Creek Upstream",
  # "Umatilla River",
  "Umatilla River Mouth", "Umatilla River Upstream",
  # "Yakima River",
  "Yakima River Mouth", "Yakima River Upstream",
  # "Walla Walla River",
  "Walla Walla River Mouth", "Walla Walla River Upstream",
  # "Wenatchee River", 
  "Wenatchee River Mouth", "Wenatchee River Upstream",
  # "Entiat River", 
  "Entiat River Mouth", "Entiat River Upstream",
  # "Okanogan River", 
  "Okanogan River Mouth", "Okanogan River Upstream",
  # "Methow River", 
  "Methow River Mouth", "Methow River Upstream",
  # "Tucannon River",
  "Tucannon River Mouth", "Tucannon River Upstream",
  # "Asotin Creek", 
  "Asotin Creek Mouth", "Asotin Creek Upstream",
  "Clearwater River",
  "Salmon River",
  "Grande Ronde River",
  # "Imnaha River",
  "Imnaha River Mouth", "Imnaha River Upstream",
  "BON to MCN other tributaries",
  "Upstream WEL other tributaries",
  
  # Loss
  "loss"
)

upstream_indices <- grep("Creek Upstream|River Upstream", model_states)
states_order_for_plot <- gsub(" Mouth", "", model_states[-upstream_indices])
# Make a couple of changes to make them be in the order from most downstream to most upstream
states_order_for_plot[10] <- "Hood River"
states_order_for_plot[11] <- "Fifteenmile Creek"
states_order_for_plot[12] <- "Deschutes River"
states_order_for_plot[13] <- "John Day River"
states_order_for_plot[15] <- "Walla Walla River"
states_order_for_plot[16] <- "Yakima River"
states_order_for_plot[19] <- "Methow River"
states_order_for_plot[20] <- "Okanogan River"

states_order_for_plot[16:29] <- states_order_for_plot[15:28]
states_order_for_plot[15] <- "BON to MCN other tributaries"
states_order_for_plot[23:29] <- states_order_for_plot[22:28]
states_order_for_plot[22] <- "Upstream WEL other tributaries"
states_order_for_plot[29] <- "loss"

states_order_for_plot[24] <- "Clearwater River"
states_order_for_plot[25] <- "Asotin Creek"
states_order_for_plot[26] <- "Grande Ronde River"
states_order_for_plot[27] <- "Salmon River"

# create a function to generate flextable
prob_flextable <- function(prob_table, trib_name){
  # first, drop all of the upstream states (these are not informative) and rename mouth states by dropping mouth from state name
  prob_table %>% 
    subset(., !(grepl("Creek Upstream|River Upstream", from))) %>% 
    mutate(from = gsub(" Mouth", "", from)) %>% 
    mutate(to = gsub(" Mouth", "", to)) -> prob_table
    
  
  
  # second, reorder the table by the states
  prob_table <- prob_table[order(factor(prob_table$from, levels=states_order_for_plot)),]
  
  
  flextable(prob_table) %>% 
    align(part = "all") %>% # left align
    set_caption(caption = paste0("Movement probabilities for ", trib_name, " Steelhead. Asterisks indicate movement probabilities that are shared across all natal origins within this DPS. Probabilities are presented as the median value and 95% credible interval.")) %>% 
    font(fontname = "Times New Roman (Body)", part = "all") %>% 
    fontsize(size = 10, part = "body") %>% 
    theme_booktabs() %>% # default theme
    FitFlextableToPage() -> table
  
  return(table)
}
```


# Executive summary

Columbia River Steelhead, who spend more time as adults in freshwater than any other salmonid in the basin, have notoriously complex adult migration pathways, characterized frequently by indirect pathways home, overshooting natal tributaries, and falling back over and through hydroelectric dams. Previous studies have characterized specific movements of interest (i.e., overshoot and fallback) and examined the effect of some factors on these movements, but have not presented a comprehensive view of the adult Steelhead migration.

<br>

Here, we present a progress update on a new modeling framework that is capable of modeling the entire adult migration of Steelhead, including upstream movements, downstream movements, and movements into tributaries. Furthermore, this model includes parameters to estimate the effects of various covariates that are hypothesized to influence movement decisions (e.g., temperature, spill, and rear type). This modeling framework translates the Columbia River Basin into a series of interconnected states, each representing a reach of the mainstem Columbia or Snake River between hydroelectric dams or a tributary of the Columbia or Snake. We converted detections of over 55,000 Steelhead over 17 years from each of the hundreds of PIT tag detection sites in the Columbia River Basin into a sequence of state visits for each fish, and fit a Bayesian multistate model to these data using the Stan programming language. This model also uses the network of PIT tag antennas in each tributary to correct for detection efficiency in each of these tributaries.

<br>

Work on this model is ongoing. A previous progress update on this model presented results for a model without any covariates [@Min2022]. At this time, the model code has been written and is set up to run with key covariates included (rear type, origin, spill, temperature, and year), but final results are not yet available due to the long run time of the model (on the order of weeks) and the difficulty of securing the computational resources required to run this model. Final model results should be available in early 2024.



# Introduction

Steelhead (anadromous *Oncorhynchus mykiss*) in the Columbia River Basin, including all those found above Bonneville Dam, are listed under the Endangered Species Act. The five Columbia River Basin distinct population segments (DPSs) were first listed in the late 1990s, and are all currently listed as threatened. Despite their protected status and continued recovery efforts, counts of returning Steelhead to Bonneville Dam have been lower in the last five years than they were at the time of listing, and recently completed 5-year reviews for Columbia River Steelhead reaffirmed their status as threatened [@NMFS2022; @NMFS2022a; @NMFS2022b; @NMFS2022c].

<br>

One element of the life history of Columbia River Basin Steelhead that may make them more vulnerable to anthropogenic modifications of the Columbia River is their pre-spawn adult migration. Relative to other salmonids, Steelhead from the Columbia River Basin spend longer in freshwater as adults. Essentially all populations of Steelhead in the Columbia River Basin are stream-maturing [@Busby1996], meaning that these fish enter freshwater in a sexually immature state and then spend up to a year in freshwater prior to spawning. Also known as summer Steelhead, these fish enter freshwater between May and October and spawn the following spring, typically between March and May [@Busby1996]. Between their entry into freshwater and arrival at spawning grounds, Columbia River Steelhead exhibit considerable variability in their migration patterns. Virtually all interior Columbia River Steelhead overwinter in freshwater; the majority of individuals are known to overwinter in tributaries, but up to 20% of individuals in a given year have been observed to overwinter in the hydrosystem, which comprises the mainstem habitat between the hydroelectric dams in the federal Columbia River power system [@Keefer2008]. Additionally, as individuals migrate upstream toward natal tributaries, the majority of individuals have been observed to temporarily stage in nonnatal tributaries downstream of their natal tributary [@High2006]. This behavior increases with increasing mainstem river temperature, indicating the use of these colder waters as coldwater refugia [@High2006]. These highly variable movement patterns and increased duration in freshwater make Steelhead more vulnerable to the hazards faced in freshwater.

<br>

Descending dams, also known as fallback [@Boggs2004], is another common behavior observed in pre-spawn adult Steelhead, with about 20% of Steelhead observed to fall back over at at least one mainstem dam [@Boggs2004]. This behavior can occur as individuals are migrating upstream to natal tributaries, which we refer to as "en-route fallback", but can also occur once individuals have ascended mainstem dams upstream of natal tributaries (a behavior known as overshoot). We refer to fallback that has occurred after Steelhead have overshot natal tributaries as "post-overshoot fallback", and in this case fallback is necessary for individuals to return to natal tributaries. Overshoot and fallback can affect the ability of individuals to successfully home to spawning grounds, and therefore are consequential for the persistence of ESA-listed populations. Individuals that fall back during their upstream migration (prior to reaching or overshooting their natal tributary) are less likely to return to their natal tributaries or hatcheries [@Bjornn2000; @Keefer2005]. Furthermore, migration success to natal tributaries decreases with increased overshooting [@Richins2018], and many overshooting fish are observed to stray to tributaries upstream of the overshoot dam.

<br>

The decreased migration success associated with overshoot and fallback may be due to the hazardous nature of downstream dam passage for adults, which is often limited to the powerhouse during the primary months that Steelhead are overwintering [@Khan2013]. The incidence of mortality for adult Steelhead passing downstream at dams is highly variable, but recent estimates of 48-hour survival at McNary Dam indicate around 90% survival for individuals passing through turbines and 97% survival for individuals passing through the spillway [@Associates2014]. Mortality in downstream dam passage routes is implicated by low survival of Steelhead kelts, which decrease with increasing number of dams that must be navigated as they move downstream to the ocean, with mortality of 84-96% for kelts released at Lower Granite Dam, 38-40% at McNary Dam, and 20-37% at John Day Dam [@Wertheimer2005].

<br>

Because of the association between overshoot and fallback and decreased migration success, previous studies have investigated the influence of various factors on the incidence of these behaviors. Rates of overshoot have been observed to vary considerably among populations, with some studies finding a positive relationship with increasing mainstem water temperature and hatchery rearing upstream of the natal tributary [@Richins2018]. In spring-summer Chinook, @Boggs2004 observed a positive relationship between fallback rates and river discharge. However, these previous studies have looked at these various factors only in isolation and for specific movements, which complicates the modeling of emergent properties and interactions between behaviors, environmental conditions, and populations, and can be challenging in the face of sparse data in some settings. 

<br>

In this progress report, we present a multistate model that is capable of modeling the entire adult Steelhead migration, from first detection at Bonneville Dam to arrival in natal tributaries. This model, which does not constrain movement to only be upstream, allows the complex, multidirectional movement of adult Steelhead to be modeled in full and allows many movements of interest, including fallback, overshoot, and homing, to be estimated in a single framework. The data used in this model were passive integrated transponder (PIT) tag detection histories. This modeling framework is capable of accommodating the effect of multiple categorical and continuous covariates on movement probabilities at each step within the migration, and estimates the effects of natal origin, rear type, temperature, spill, and year on certain movement probabilities. 

<br>

The covariate effects were structured in the model to test specific hypotheses about the effects of these factors on movements of interest. Fish from different DPSs and and of different rear types were modeled separately, facilitating the comparison of movement probabilities along these axes. Within a DPS/rear type combination, covariates were added for the effect of natal origin for any movements within DPS boundaries, ensuring that fish of different natal origins had different movement probabilities as they neared their natal tributaries. Temperature effects were included only for movements that were either upstream or into tributaries, as previous studies have indicated that Steelhead respond to temperature by seeking out colder refugia, either in tributaries [@High2006] or in upstream mainstem reaches [@Richins2018]. In contrast, spill effects were only included for downstream (fallback) movements, but with different structures based on whether a movement was post-overshoot fallback or en-route fallback. Post-overshoot fallback modeled as a function of days of winter (January, February, and March) spill, as the presence of a spillway passage route has previously been shown to be more important than the volume of spill for facilitating downstream passage of adults at dams [@Wertheimer2005]. In contrast, en-route fallback was modeled as a function of the volume of spill, as this type of fallback is assumed to be an involuntary movement caused by hydrosystem conditions. Finally, a random effect of year was included for movements within a fish's DPS to account for interannual variation that was not explicitly accounted for by the other covariates. A random effect of year was not included for movements outside of a fish's DPS, as outside of the DPS, we expected individuals to behave similarly regardless of the year.

<br>

By examining how Steelhead movement probabilities, particularly those of conservation concern, such as overshoot, fallback, homing, and straying, vary by population and are influenced by various factors, this modeling framework will improve our understanding of how both environmental and anthropogenically influenced conditions affect how Steelhead move within the Columbia River and its tributaries.



# Methods

## Study area
![Figure 1. The study area, showing all mainstem dams that currently have PIT arrays. Dams that are used to delineate states in the model are in black, whereas those that are not are in grey. Tributaries where fish in our dataset originated are labeled. BON = Bonneville Dam; TDA = The Dalles Dam; JDA = John Day Dam; MCN = McNary Dam; PRA = Priest Rapids Dam; RIS = Rock Island Dam; RRE = Rocky Reach Dam; WEL = Wells Dam; ICH = Ice Harbor Dam; LMO = Lower Monumental Dam; LGO = Little Goose Dam; LGR = Lower Granite Dam.](.//figures/CRB_map_pres_dams.pdf){width=100%}

## Modeling overview
![Figure 2. The model schematic. There were 29 states in our model: 9 mainstem states (outlined in blue), 19 tributary states (outlined in green), and the absorbing "loss" state (not pictured).](.//figures/full_model_diagram.jpg){width=100%}

In our model, the Columbia River and its tributaries are modeled as a series of connected states, with states defined as either reaches of the mainstem Columbia or Snake River between dams with PIT tag detection capabilities in the adult ladders, or tributaries with PIT tag detectors. Fig. 2 shows all of the states in our model; movements over some dams (e.g., The Dalles Dam, John Day Dam, Lower Monumental Dam, or Lower Goose Dam) were not explicitly modeled due to these dams not having adult PIT tag detection capabilities for the duration of our study period.

<br>

An additional state in our model not shown in the schematic, but which can be reached from any state, is the absorbing "loss" state, which a fish enters once the detection history ends. Once a fish has entered the loss state, it can no longer leave it. Movements into the loss state are either mortality (via natural mortality, harvest, mortality due to the hydrosystem, etc.), the start of kelt movement following spawning (as all kelt movements were removed to isolated the adult migration prior to spawning), or unobserved movements out of the state, which could be due to missed detections at PIT tag antennas, movements into areas without PIT tag detectors (e.g., certain tributaries), or movements into tributaries that failed to reach PIT tag antennas.

## Preparing data

### Accessing PIT tag data

PIT tag data were obtained from the Columbia Basin PIT Tag Information System (PTAGIS). Only known-origin individuals (based on known release sites) were included in this dataset. To ensure that only individuals marked as juveniles were retained in the dataset, all individuals that were greater than 350 mm at time of marking were removed. To select returning adults, only individuals that were seen in the adult fishways at Bonneville Dam were selected. To ensure that there were enough data for each population included in this dataset, only populations (defined as the combination of natal tributary and rear type) that had at least 350 individuals distributed across 8 run years were retained. Additionally, only populations with instream PIT tag detection sites in their natal tributaries were retained; if sufficient instream detection sites only became available during the later part of our study period, only individuals from those years were retained. Run years were separated by June 1 of each year, and run year 2005/2006 (beginning on June 1, 2005) was selected as the first year in our dataset. In total, 27 populations from 17 different tributaries met these criteria: Hood River (hatchery and wild), Fifteenmile Creek (wild), Deschutes River (wild), John Day River (wild), Umatilla River (hatchery and wild), Walla Walla River (hatchery and wild), Yakima River (wild), Wenathee River (hatchery and wild), Entiat River (wild), Methow River (hatchery and wild), Okanogan River (hatchery), Tucannon River (hatchery and wild), Clearwater River (hatchery and wild), Asotin Creek (wild), Grande Ronde River (hatchery and wild), Salmon River (hatchery and wild), and Imnaha River (hatchery and wild). Once the tag codes were identified for each of these populations, a complete tag history report was run in PTAGIS for all of the tag codes in our dataset.

### Processing PIT tag data into detections at various sites

To convert detections of fish at individual PIT tag antennas into a history of movements between different reaches of the Columbia, Snake, and their tributaries, it was first necessary to interpret detections at different PIT tag antennas. For instream tributary detection sites, as well as mainstem sites in between dams, processing only entailed assigning detections at these sites to the corresponding model state. For detection sites at dams, more involved processing was required to interpret detections.

<br>

The first step in interpreting detections at dams was to identify the multiple passage routes associated with each dam. In many cases, multiple passage routes were grouped together into a single interrogation site, and assigning antennas to these different passage routes was necessary to interpret how fish were utilizing these passage routes. For example, antennas at Ice Harbor Dam are all grouped together in PTAGIS as "Ice Harbor Dam (combined)", when these antennas are actually in three different passage routes: the North Shore Ladder, the South Shore Ladder, and the Juvenile Bypass System.

<br>

The second step was to identify, when possible, entrance and exit antennas within each upstream passage route. By distinguishing entrance and exit antennas, we were able to identify when fish detections in adult fishways were not ascents, but were rather aborted ascent attempts or descents. Entrance and exit antennas were only distinguished when either two distinct groupings of antennas existed in separate parts of the same passage route, or in the case of Bonneville Dam, when there are enough consecutive weirs with PIT tag detection antennas to separate the antennas in these weirs into entrance and exit antennas. When fish were only seen at entrance antennas, this was noted to be an aborted ascension attempt. When fish were first seen at the exit antennas at an adult fish ladder and last seen at the entrance antennas of the same fish ladder, this was noted to be a descent through the ladder. If a fish was first seen at the entrance antennas and last seen at the exit antennas, this was noted to be an ascent. Entrance and exit antennas were identified at all adult fishways except for McNary Dam Washington Shore Ladder (prior to March 2006), Priest Rapids Dam, Rock Island Dam, Rocky Reach Dam, Wells Dam (prior to 2013), and Ice Harbor Dam.

<br>

Additionally, we identified antennas in adult fish facilities/traps at ladders. For most dams (e.g., Ice Harbor Dam, Priest Rapids Dam, or Lower Granite Dam, where traps were operated but adults were returned after processing), we treated detections in the adult fish facility the same as detections in other parts of the adult ladder, as adults were not removed. However, in the case of Wells Dam, trapped fish were either moved to the hatchery or trucked off-site. As such, any terminal detections in the trap at Wells Dam were classified as terminal trapping events, and were classified as fish moving to the absorbing "loss" state.

<br>

Once the antennas had been appropriately assigned, a 48-hour threshold was used to distinguish separate detection events at a site. However, in some passage routes fish were observed in the same route for days at a time, so no time threshold was set, and instead we used the sequence of antennas to distinguish separate detection events at a site. For example, some individual fish did not exit the Washington shore passage route at Bonneville Dam for upwards of 100 days, so new visits to this site were only distinguished by new visits to the entrance antennas, regardless of the amount of time between detections at other antennas in the passage route.

### Turning detections at different sites into state transitions

With antennas appropriately assigned to different passage routes and the sequence of antenna detections at the adult fishways used to interpret directionality, the output from the previous script was used as input into the next script, which converted a history of detections at sites into a history of movements between states, as defined in Fig. 2. For detections at sites in the fish passage routes at dams, the directionality of movement, as assigned in the previous script, was used to inform transitions between states. Ascents at dams indicated a transition from the downstream state to the upstream state; descents at dams (either through the juvenile bypass system or descents through the ladder) indicated a transition from the upstream state to the downstream state. Aborted ascension attempts were noted, but interpreted as no transition from the current state. Detections in tributary sites that immediately followed detections in mainstem sites were interpreted as transitions from the mainstem state into the tributary. Once a fish transitioned into a given state, any subsequent detections in that state were ignored, as they did represent transitions between states. Therefore, if fish were detected at sites within the same tributary consecutively, or if fish were detected at instream sites in the mainstem following transition into that mainstem state, these detections were ignored.

<br>

With the exception of a few downstream routes, such as the spillway at Lower Granite Dam following the installation of the PIT tag antennas in 2020, or the Bonneville Corner Collector, PIT tag detection capabilities at each dam were limited to the adult fish ladders and the juvenile bypass system. As such, PIT tag antennas have historically been unable to directly monitor fallback at dams, unless an individual subsequently reascends the dam [@Boggs2004]. With the installation of instream antennas in natal tributaries, fallback to home has been monitored [@Richins2018] by noting when individuals entered natal tributaries downstream of a dam that was previously ascended. In this study, we monitored fallback to the greatest extent possible with the current configuration of PIT tag antennas by using our knowledge of the connections between states in our model to note when downstream movements must have occurred. For example, if we noted two consecutive ascents at Bonneville Dam, or if we observed a fish in the John Day River after ascending McNary Dam, we added a fallback event in between these events. In this way, we included fallback that occurred on the mainstem downstream of the natal tributary (similar to @Boggs2004), fallback to home (similar to @Richins2018), and other fallback movements, such as fallback upstream of the natal tributary that did not end in homing. Using a similar strategy of interpolating state transitions based on state connectivity, we also interpolated upstream movements that were missed by the PIT tag antennas in adult fish ladders, although these missed detections were very infrequent, as detection probabilities in adult ladders is close to 100% [@Richins2017].

<br>

Once we determined a history of movement between states, we then subset this movement history to eliminate any movement that occurred as a juvenile or as a kelt in order to isolate only the portion of the adult migration prior to reaching spawning areas. Based on manual inspection of detection histories, juvenile movements were identified using the following criteria: (1) any detections within 90 days of juvenile release; (2) any detections on or before June 15 of the same year that an individual was released, or detections on or before June 15 in a given year if individual was released on or after July 1 of the previous year. The June 15 cutoff date was chosen based on the timing of juvenile outmigration at Bonneville Dam, 95% of which occurs before this date in nearly every run year (data from CBR DART). Kelt movement was identified as any downstream movement occurring between March and July (following spawning). Repeat spawners were also identified in the dataset based on detections at the Bonneville Dam adult ladders occurring at least 180 days after they were initially seen at Bonneville Dam. For the purposes of our analysis, repeat spawners were treated as new fish when they returned to Bonneville Dam.

## Model covariates

### Temperature data
Daily average forebay and tailrace temperatures were queried from the Columbia Basin Conditions portal from the CBR DART page for the eight dams for which movement was explicitly modeled (BON, MCN, PRA, RIS, RRE, WEL, ICH, and LGR). Due to the noise and gaps inherent to the temperature data, a series of steps were performed to clean this data. To address outliers in the temperature data, two steps were taken. First, plots of temperature were manually inspected and sequential runs of temperature points that were outside of the range of possible values for that time of year were removed. Next, a filtering algorithm was applied to remove any temperature values that were more than four degrees outside of the interannual average temperature value for that day of the year, as well as any values that were more than two degrees outside of the 7-day moving average. To address the incomplete temporal resolution for temperature at each dam in our modeling framework, a state-space model was fit using the MARSS package [@Holmes2012a]. This model took as inputs the cleaned temperature data at the forebay and tailrace for the eight dams (a total of 16 temperature time series). The model was structured with only a single process (the basin-scale temperature) and 16 observations of that process. Each dam (both the forebay and tailrace temperature observations) had a different offset/bias term (8 total). Model-estimated temperatures on each day for each dam (the estimate of the basin-scale temperature plus the dam-specific offset) were z-scored prior to inclusion in the model.

The model is structured as follows:
$$
x_t = x_{t-1} + w_t
$$
$$
\mathbf{y}_t = \mathbf{Z}x_t + \mathbf{a}_t + \mathbf{v}_t
$$

The terms have the following definitions:

* $x$ is the temperature of the Columbia River Basin
* $w$ is the process error, where $w_t \sim \text{normal}(0, Q)$ and where $Q$ is an estimated parameter
* $\mathbf{y}$ is a 16x1 column vector that contains 16 observations of the temperature: 8 dams x 2 observations at each dam (forebay and tailrace)
* $\mathbf{Z}$ is a 16x1 column vector containing only 1s that maps the process (the basin temperature) to the observations (forebay and tailrace temperatures at each dam)
* $\mathbf{a}$ is a 16x1 column vector that contains 8 different offset terms each repeated twice (for the forebay and tailrace temperatures at each dam)
* $\mathbf{v}$ is a 16x1 column vector of the observation errors, where $v_t \sim \text{MVN}(0, R)$ and where $R$ is an estimated parameter


<br>

Our hypothesis concerning the effect of temperature was that the temperature experienced by a fish while they were in a state influenced their decision to seek cooler refuge (either in an upstream mainstem reach or in a tributary). To estimate the temperatures experienced by fish, it was first necessary to calculate the median residence time in each state in our model. This was done by calculating the amount of time spent in each state by each fish in our dataset (the difference between date on which a fish was observed entering a state and the date on which a fish was observed exiting a state) and then taking the median time spent in each state across all fish. To estimate the mean temperature experienced by the fish while in a state, the mean temperature across a window of time (defined as the date a fish was observed entering a state plus the median residence time for all fish in that state) was taken. The downstream dam for a state was used as the source of temperature data for that state.

### Spill data
Daily average spill (in thousands of cubic feet per second) were queried from the Columbia Basin Conditions portal from the CBR DART page for the eight dams for which movement was explicitly modeled (BON, MCN, PRA, RIS, RRE, WEL, ICH, and LGR). Spill data were processed in two different ways to facilitate the inclusion of the two hypothesized relationships between spill and fish fallback over dams.

<br>

En-route fallback goes against the desired direction of movement for all fish, as their goal is to continue traveling upstream. Our hypothesis concerning en-route fallback is that it is involuntary; i.e., it occurs as a result of river conditions (spill, flow) and/or individual condition. As such, our hypothesis for the relationship between spill and en-route fallback is that it is related to the volume of spill, as this would serve to push fish back downstream over a dam via the spillway (or alternatively, serves as a proxy for flow conditions in the river). The approach that we used for this spill covariate is the same as was used for temperature, i.e., the use of windows and taking the average spill during that window. However, spill data was not z-scored, as the zeros in the data are informative.

<br>

In contrast, post-overshoot fallback is a desirable outcome for all fish, as this movement helps them get closer to their natal tributary. Our hypothesis concerning post-overshoot fallback is that it is voluntary; i.e., it occurs when fish make the decision to go back downstream and towards their natal tributaries. As such, our hypothesis for the relationship between spill and post-overshoot fallback is that it is related to the presence of spill, as the presence of spill allows fish to find a safe route back downstream. This is supported by the work of @Richins2018 and @Wertheimer2005, who found that even small amounts of surface flow were effective for routing steelhead kelts away from turbines, indicating that the availability of surface passage options may be more important than the volume of flow. The approach we used for this covariate was to find the total number of days with any amount of spill in the months of January, February, and March, which is when post-overshoot fallback is predicted to occur (after overwintering).



## Statistical methods

### Modeling detection efficiency in tributaries

Over the course of our study period, the network of PIT tag detection arrays in tributaries was highly dynamic, as antennas were installed, decommissioned, and upgraded. From 2010 to 2018, the number of tag detection arrays in tributaries almost tripled [@Morrisett2018], and in some years of our study, the tributaries in our model had no active antennas at all [@Richins2017]. As a consequence, our ability to detect fish entering these tributaries varied considerably both temporally and spatially (between tributaries).

<br>

To address this, we estimated detection efficiency in tributaries by calculating the detection efficiency at the PIT tag detection site closest to the river mouth (i.e., the confluence of the tributary with either the Columbia or Snake River). We estimated detection efficiency by taking the individuals that were seen at detection sites upstream of the river mouth site and calculating what proportion were seen at the river mouth site. For 14 of the 17 tributaries in our model (Table 1), we identified a PIT tag detection site on the mainstem tributary suitable for calculating detection efficiency; three tributaries (the Clearwater River, Salmon River, and Grande Ronde River) lacked a suitable site and therefore detection efficiency was not calculated for these tributaries. As such, estimates of movement probability into these tributaries will be biased low (and conversely, the loss probability will be biased high), as detection efficiency was assumed to be 100%.

<br>

In our estimation of detection efficiency, we included two covariates: (1) a categorical covariate representing different antenna configurations, and (2) a covariate for the effect of discharge. Different categorical covariates were chosen based on the operational history of each interrogation site (Table 1). We identified major changes in site configuration which were likely to have affected the detection efficiency at these sites, such as the installation of new antennas, arrays being moved, or components being upgraded. The years in which these changes occurred were then used to inform which categorical covariate for antenna configuration was used. We chose to include discharge as a covariate for detection efficiency as well because of the relationship between discharge and river stage, which affects the volume of the river covered by the range of the antennas (see Fig. 3 for an example). Discharge data were queried from USGS by finding the station on the interactive USGS dashboard (https://dashboard.waterdata.usgs.gov) closest the river mouth array and navigating to the data page for the specific site. Discharge data were available for all tributaries except Fifteenmile Creek and the Imnaha River; these tributaries therefore had detection efficiency estimated only via the categorical covariate (intercept) for antenna configuration.

<br>

![Figure 3. Hood River Mouth Array, configuration as of July 21, 2022. Green lines indicate the approximate low water line, while red lines indicate the approximate high water line. Note that at the high water line, approximately 2/3 of the river channel is not covered by the PIT tag antennas. Figure from PTAGIS (https://www.ptagis.org/Sites/InterrogationSites?code=HRM).](.//figures/hood_river_site.png){width=130%}

<br>
<br>  
<br>

```{r det_eff_cat_changes, echo = FALSE, warning = FALSE, message = FALSE, tab.cap.pre = "Table 1"}

tributaries <- gsub("_", " ", natal_origin_order)

trib_cat <- data.frame(Tributary = c("Hood River", "Fifteenmile Creek", "Deschutes River",
                                     "John Day River", "Umatilla River", "Umatilla River",
                                     "Walla Walla River", "Walla Walla River", "Walla Walla River",
                                     "Yakima River", "Wenatchee River", "Entiat River",
                                     "Methow River", "Methow River", "Okanogan River",
                                     "Tucannon River", "Tucannon River", "Asotin Creek",
                                     "Asotin Creek", "Imnaha River"),
                       Years = c("15/16-21/22", "12/13-18/19", "12/13-19/20",
                                 "12/13-21/22", "07/08-13/14", "14/15-21/22",
                                 "05/06-11/12", "12/13-18/19", "19/20-21/22",
                                 "04/05-21/22", "10/11-21/22", "07/08-21/22",
                                 "09/10-16/17", "17/18-21/22", "12/13-21/22",
                                 "10/11-19/20", "20/21-21/22", "11/12-17/18",
                                 "18/19-21/22", "12/13-21/22"),
                       Site = c("Hood River Mouth (HRM)", "Fifteenmile Ck at Eighmile Ck (158)", "Deschutes River Mouth (DRM)",
                                "John Day River, McDonald Ferry (JD1)", "Three Mile Falls Dam (TMF)", "Three Mile Falls Dam (TMF)",
                                "Oasis Road Bridge (ORB)", "Walla Walla R at Pierce RV Pk (PRV)", "Walla Walla River Barge Array (WWB)",
                                "Prosser Diversion Dam (PRO)", "Lower Wenatchee River (LWE)", "Lower Entiat River (ENL)",
                                "Lower Methow River at Pateros (LMR)", "Lower Methow River at Pateros (LMR)", "Lower Okanogan Instream Array (OKL)",
                                "Lower Tucannon River (LTR)", "Lower Tucannon River (LTR)", "Asotin Creek Mouth (ACM)",
                                "Asotin Creek Mouth (ACM)", "Lower Imnaha River ISA @ km 7 (IR1)"),
                       Configuration = c("Initial", "Initial", "Initial",
                                         "Initial", "Initial", "Antenna installation at entrance to adult ladder",
                                         "Initial", "Initial", "Initial",
                                         "Initial", "Initial", "Initial",
                                         "Initial", "Site was moved 5 km upstream and transceivers replaced", "Initial",
                                         "Initial", "All antennas replaced, additional antenna installed", "Initial",
                                         "All components replaced and upgraded", "Initial"))

flextable(trib_cat) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Tributary PIT tag antenna configurations used in detection efficiency estimation. Site refers to the PIT tag detection site chosen for the detection efficiency estimation, based on its location close to the mouth of the tributary. Configuration refers to the configuration of antennas at the site, where Initial is the name given to the antenna configuration at the site at the start of the time series, and any subsequent changes from the initial configuration at the site are noted in this column.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage(pgwidth = 6)
  # fit_to_width(max_width = 14)
```

<br>
<br>  
<br>

Detection efficiency at the tributary mouth site was then estimated using a logistic regression, with detection a function of an intercept for the categorical covariate of site configuration, and a slope term (unique to each tributary) multiplied by the mean discharge in that run year. Only fish that were detected at an upstream site in the same tributary were included in the detection efficiency estimation.

<br>

$$
z_{i} \sim \text{Bernoulli}(p_{i})
$$
$$
\text{logit}(p_i)=\alpha_{j, k}  +  \beta_{j}  discharge_{j,t}
$$

In this equation, $z$ is whether or not an individual fish was detected (0 or 1), $p$ is the probability of detection, $\alpha$ is the categorical covariate for site configuration, and $\beta$ is the slope for the effect of discharge on the probability of detection efficiency.

The indices represent the following:

- $i$ is the individual fish
- $j$ is the tributary
- $k$ is the site configuration (a categorical variable)
- $t$ is the run year

A Stan [@Carpenter2017] model was used to estimate detection probability in each tributary. Discharge values were Z-scored prior to the model being fit. The posteriors from this model for each of the $\alpha$ (site configuration covariates) and $\beta$ (effect of discharge) terms were used as priors in the primary Stan model that was used to estimate movement. The fit for detection efficiency for each tributary can be found in Appendix 1.

<br>

Movements from mainstem states into tributaries were the only movements for which detection efficiency was estimated. For the other two types of movements (upstream movements between mainstem states and downstream movements between mainstem states), detection efficiency was assumed to be 100%. This assumption for upstream movements via fish ladders is supported by estimates of detection efficiency at these ladders, which are near 100% [@Richins2018]. However, this assumption does not hold for fallback movements, which in reality have very low detection probabilities. By interpolating fallback movements based on the sequence of state visits, we are able to model the probability of apparent fallback, but we are not able to capture fallback events where fish are not subsequently detected. The consequence of this is that unobserved fallback movements will instead appear as movements into the loss state, leading to estimates of loss from a state being too high, and estimates of fallback being too low. Therefore, all fallback movement probabilities should be interpreted as lower bound estimates of fallback.


### Movement model

#### Overview
The history of state transitions for each individual PIT-tagged fish, the information on that fish's natal origin, and the previously described covariates were the inputs for the multistate model. The multistate model was implemented in a Bayesian framework using the Stan programming language [@Carpenter2017]. The multistate model is constructed as a series of states, defined as either reaches of the mainstem Columbia or Snake Rivers between dams with active PIT tag antennas for the duration of our study period or tributaries that flow into the Columbia or Snake Rivers (Fig. 2). All fish in our model begin when they are first detected as adults in the fish ladders at Bonneville Dam. At each state in our model, each fish is assigned a probability of moving to any of the states connected to the current state, or into the absorbing loss category, which a fish enters once the detection history ends. Each of these probabilities will be evaluated through a categorical logit model, with an intercept term (a grand mean, for all fish in the dataset) as well as terms for each of the covariates in our model (origin, year, spill, and temperature). The loss probability was calculated as 1 - the sum of the other probabilities, enforcing a constraint that all movement probabilities have to sum to 1.

<br>

Due to the computational requirements of evaluating the detection histories of over 55,000 individual fish, the model will be fit to six different datasets, corresponding to the hatchery or wild fish from the three Steelhead DPSs found exclusively upstream of Bonneville Dam: the Middle Columbia DPS, the Upper Columbia DPS, and the Snake River Basin DPS. This modeling framework has the additional benefit of estimating different movement probabilities (and covariate effects) for hatchery and wild fish, facilitating comparisons between the two. Each of the DPS models will be run for 1000 warmup and 1000 sampling iterations. At this moment in time, full length model runs have not yet run to completion, but we are in the process of setting up the modeling framework on high-performance computational resources at the UW. All code is available at https://github.com/markusmin/steelhead.

<br>

#### Covariate inclusion

In addition to the effects of DPS and rear type that are estimated via the separate estimation of model parameters for hatchery and wild fish from each DPS, four covariates were explicitly included via parameters in the model: origin, temperature, spill, and year.


##### Origin

To reduce the number of parameters in the model, a fixed effect of natal origin was included only for state transitions into or out of states within the DPS boundaries, whereas for states outside of the DPS, all origins shared a common movement probability. This model structure allowed the effect of unique natal origins to differentiate as they neared natal tributaries. Natal origin was modeled as a fixed effect.


##### Temperature

Two separate temperature effects were estimated in our modeling framework, to account for the temporal aspect of temperature. Because temperature is strongly correlated with day of year, which has been previously noted to influence Steelhead migration patterns [@Siegel2021], we divided the effect of temperature into a winter/spring effect (January 1 - May 31) and a summer/fall effect (June 1 - December 31). Depending on the day of year of each movement, the temperature in the window was either multiplied by the winter/spring temperature parameter or the summer/fall temperature parameter. Approximately 96% of all movements occurred in the summer/fall period.

The temperature effects were structured to allow a temperature effect only for movements from a mainstem state to the mainstem state upstream of that state, or from a mainstem state into a tributary. Furthermore, temperature effects were structured to allow different natal origins to have a different response to temperature within the DPS boundaries. As such, the same origin structure was used as was used for the origin effects - temperature effects were shared outside of a DPS, but within a DPS each natal origin had a separately estimated parameter for the effect of temperature on each movement. Temperature was modeled as a fixed effect.


##### Spill

For the effect of the volume of spill within a window of time, only en-route fallback movements included an effect for the volume of spill. This parameter was shared between all origins. For the effect of the number of days in the winter with some volume of spill, only post-overshoot fallback movements included an effect for the number of days of spill during the winter months. This parameter was shared between all origins for which the movement was a post-overshoot fallback movement. Therefore, for any fallback movement, either the effect of the volume of spill or the number of days of winter spill was included, depending on the relation of that dam to the fish's natal origin. Spill was modeled as a fixed effect.

##### Year

Within the datasets for each of the six populations (3 DPSs x 2 rear types), all individuals were pooled across years when fitting the model, but a random effect of year for certain movements was included to allow the movement probabilities to vary interannually and account for year specific differences that weren't captured by the covariates included in the model. The setup for the inclusion of year effects was the same as that for origin effects - a random effect for each year was included only for state transitions into or out of states within the DPS boundaries, and random effects for year were all origin specific (no DPS-wide year effects). One reason for this modeling choice was the computational necessity of restricting the number of movements that receive a random effect for each of the 17 years in our dataset, as well as needing enough data for each movement to estimate a separate effect for each origin for each year. A second, ecological reason for this choice was based on our a priori hypothesis that interannual differences would mostly emerge when fish were nearing natal tributaries. Downstream of the DPS, individuals are expected to behave similarly regardless of the year, as all fish have natal tributaries that are upstream. Year was modeled as a random effect.


#### Statistical implementation and detection efficiency correction

For each transition of a fish out of a state, there are $n$ possible non-loss transitions out of the current state, which correspond to the number of arrows out of the state as seen in Fig. 2. The true probability ($p_{actual}$) of moving to state $m$ ($m$ = 1, ..., n) from the current state is given as follows:

<br> 



$$
\begin{aligned}
p_{actual, m} = \frac{exp(b_{0,m} + [covariate\:effects]_{m})}{1 + exp(b_{0,1} + [covariate\:effects]_{1}) + 
... exp(b_{0,n} + [covariate\:effects]_{n})}
\end{aligned}
$$

<br>

In this equation, the parameter $b_0$ is the intercept (the grand mean for all fish in the DPS), and the term $[covariate\:effects]$ is a placeholder for the different covariates that are included in this model. Specifically, the covariates are estimated as follows:

* $b_0$ is a fixed effect for the grand mean of all fish in the model (i.e., the grand mean for all fish of one rear type from one DPS)
* $b_{origin}$ is a fixed effect for the natal origin
* $b_{spill-window}$ is a fixed effect for the volume of spill
* $b_{spilldays}$ is a fixed effect for the days of winter spill
* $b_{tempearly}$ is a fixed effect for temperature when a movement occurs during the winter and spring months (1 Jan - 31 May) for movements outside of a fish's DPS
* $b_{template}$ is a fixed effect for temperature when a movement occurs during the summer and fall months (1 June - 31 December) for movements outside of a fish's DPS
* $b_{origin,tempearly}$ is a fixed effect for temperature for that specific origin when a movement occurs during the winter and spring months (1 Jan - 31 May) for movements inside a fish's DPS
* $b_{origin,template}$ is a fixed effect for temperature for that specific origin when a movement occurs during the summer and fall months (1 June - 31 December) for movements inside a fish's DPS
* $b_{origin,year}$ is a random effect of year for that specific origin. Random effects were assumed to be distributed normally, with a mean of zero and a standard deviation estimated in the model

All fixed effects were estimated using a diffuse normal prior with a mean of 0 and a standard deviation of 10, and random effects were estimated using a diffuse cauchy prior (location of 0 and scale of 1) on the standard deviation.


As stated earlier, the covariate effects included vary depending on the type of movement and its relation to the fish's natal origin. To provide an example of the variable nature of which covariates to include, for the probability of a Wenatchee River fish falling back over Rocky Reach Dam, the covariate effects term in the numerator would be as follows:

<br> 

$$
b_{origin,1} + b_{spillwindow,1} * spillvolume +  b_{spilldays,1} * spilldays + b_{origin,year,1}
$$

<br> 

This is because the movement is:

* inside the Upper Columbia DPS boundaries, so there is an effect of origin
* a fallback movement over a dam, so there is an effect of the volume of spill
* a post-overshoot fallback movement over a dam (because Rocky Reach Dam is upstream of the Wenatchee River), so there is an effect of the days of spill during the winter months
* inside the Upper Columbia DPS boundaries, so there is an effect of year
* not an upstream movement, so there is no effect of temperature

<br>

Once the probabilities of entering any non-loss states have been estimated, the loss term is given by the following equation:
$$
p_{actual,loss} = 1 - \sum_{m=1}^{n} p_{actual,m}
$$

<br> 

This generates a vector of probabilities, corresponding to the true movement probability from the current state to each of the connecting states. However, because perceived movement is a product of both the true movement and the detection probability of various PIT tag arrays, we must correct for this detection probability to separate our process of interest (the true movement probabilities, $p_{actual}$) from the observation process (the detection probability, $p_{detection}$). The product of $p_{actual}$ and $p_{detection}$ is $p_{observed}$, which is used to evaluate the likelihood of the observed PIT tag data. We only estimate $p_{detection}$ for tributaries in our model; $p_{detection}$ in adult fish ladders is assumed to be one, with any known missed detections interpolated (see section 3.3.3), and there is no way to estimate $p_{detection}$ in downstream mainstem passage routes. The consequence of an inability to estimate $p_{detection}$ in downstream mainstem passage routes is that this is assumed to be 100%. The consequence of this is that if there is a missed detection and that fish is not later seen (therefore, the missed detection cannot be interpolated), the downstream movement probability will be biased low, and the loss probability will be biased high.

<br> 

Once we have estimated $p_{actual}$, the detection efficiency correction is implemented for all transitions for which we can calculate a detection efficiency, to generate $p_{observed}$. Given that for almost every tributary, detection efficiency could not be calculated for every year, the first step was to identify which tributaries that connect to a mainstem state had the ability to estimate detection efficiency in the year in which the transition occurred. For each of the transitions for which a detection efficiency could then be estimated, the following correction was made: 

<br>

First, the detection efficiency of that tributary in that year ($t$) with that year's mean discharge was modeled, using the parameter values that were estimated in the model described in 3.5.1 as priors for the same parameters in this model:

$$
p_{detection,j,t} = exp(\alpha_{j, k}  +  \beta_{j}  discharge_{j,t})/(1 + exp(\alpha_{j, k}  +  \beta_{j}  discharge_{j,t}))
$$

<br>

Next, the probability of the corresponding transition in the vector of observed transitions was adjusted:
$$
p_{observed,j,t} = p_{actual,j} * p_{detection,j,t}
$$

<br>

Since any transitions that were unobserved but occurred would appear as fish moving to the absorbing loss state, this movement probability was also adjusted accordingly for each of the $n$ tributaries that connect to that mainstem state:
$$
p_{observed,loss} = p_{actual, loss} + \sum_{j=1}^{n} p_{actual,j} * (1 - p_{detection,j,t})
$$

<br>

With the vector of observed transition probabilities generated, the likelihood of observing the next movement ($x$) of fish $z_i$ was defined as follows:

<br>

$$
z_{i,x} \sim \text{categorical}(p_{observed,i,1}, p_{observed,i,2}, p_{observed,i,3} ... p_{observed,i,n}, p_{observed,i,loss})
$$

<br>

Formally, the likelihood is evaluated as follows:
$$
f(x | \mathbf{p}) = \prod_{m=1}^{n} p_{m}^{x_m}
$$
In this likelihood, $\mathbf{p}$ is the vector of observed probabilities and $n$ is the possible movements out of that state.

<br>

In these equations, $p_{detection}$ is the conditional probability of detection, $p_{actual}$ is the vector which contains the true movement probabilities, $p_{observed}$ is the vector which contains the observed movement probabilities, $\alpha$ is the categorical covariate for site configuration, $\beta$ is the slope for the effect of discharge on the probability of detection efficiency, and $z_{i,x}$ is the next observation of the fish. The indices represent the following:

- $i$ is the fish
- $x$ is the observation of fish $i$
- $m$ is the state
- $j$ is the tributary
- $k$ is the site configuration (a categorical variable)
- $t$ is the run year

# Results

## Summary statistics


### Sample sizes

```{r fish_table_load, echo = FALSE, message = FALSE, warning = FALSE}
read.csv(here::here("CBR_report_2023", "tables", "population_table.csv"), row.names = 1) -> fish_year_origin_table

# fish_year_origin_table[match(natal_origin_order, fish_year_origin_table$natal_origin),] -> fish_year_origin_table

fish_year_origin_table %>% 
  arrange(factor(natal_origin, levels = natal_origin_order)) -> fish_year_origin_table

fish_year_origin_table %>% 
  mutate(natal_origin = gsub("_", " ", natal_origin)) -> fish_year_origin_table

fish_year_origin_table %>% 
  dplyr::select(-c(natal_origin, rear_type_code)) -> fish_year_origin_table

colnames(fish_year_origin_table) <- c("Population", "05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "Total")
```

A total of `r sum(fish_year_origin_table$Total)` PIT-tagged fish were in our dataset, distributed across `r ncol(fish_year_origin_table) - 2` run years. The three populations with the most fish were the Salmon River (hatchery), the Grande Ronde River (hatchery), and the Clearwater River (hatchery).

<br>
```{r fish_table_print, echo = FALSE, message = FALSE, warning = FALSE, tab.cap.pre = "Table 2"}
flextable(fish_year_origin_table) %>% 
  align(part = "all") %>% # left align
  set_caption(caption = "Number of tagged fish in our dataset, by population (combination of natal origin and rear type) and run year.") %>% 
  font(fontname = "Times New Roman (Body)", part = "all") %>% 
  fontsize(size = 9, part = "body") %>% 
  fontsize(size = 8, part = "header") %>% 
  theme_booktabs() %>% # default theme
  FitFlextableToPage(pgwidth = 7)

as.data.frame(t(fish_year_origin_table)) %>% 
  row_to_names(1) %>% 
  rownames_to_column("Year") -> fish_year_origin_table_2

```

<br>

# Discussion

## Next steps
The model described above will be run on UW's HYAK high performance compute clusters. Based on model performance and diagnostic testing, it will likely take around 3-4 weeks to run each of the six models; however, these can be run at the same time on different computing nodes, which should reduce the total time required. We anticipate being able to share modeling results in early 2024.


# References

<div id="refs"></div>



# Appendix 1: Detection probabilities
![Figure 4. Modeled detection probability by tributary and timeframe as a function of discharge and PIT tag antenna configuration.](.//figures/DE_plots.pdf){width=100%}